/**
 * PhysicsJS v0.5.0 - 2013-09-03
 * A modular, extendable, and easy-to-use physics engine for javascript
 * http://wellcaffeinated.net/PhysicsJS
 *
 * Copyright (c) 2013 Jasper Palfree <jasper@wellcaffeinated.net>
 * Licensed MIT
 */
!function(a,b){"object"==typeof exports?module.exports=b.call(a):"function"==typeof define&&define.amd?define(function(){return b.call(a)}):a.Physics=b.call(a)}(this,function(){"use strict";var a=function c(){return c.world.apply(c,arguments)};a.util={},function(b){function c(){}function d(a,b,c,d){function e(){var d=arguments,k=h?this:b;if(f||(a=b[i]),c.length&&(d=d.length?(d=bb.call(d),j?d.concat(c):c.concat(d)):c),this instanceof e){g.prototype=a.prototype,k=new g,g.prototype=null;var l=a.apply(k,d);return o(l)?l:k}return a.apply(k,d)}var f=n(a),h=!c,i=b;if(h){var j=d;c=b}else if(!f){if(!d)throw new TypeError;b=a}return e}function e(){for(var a,b={shadowedProps:E,arrays:"isArray(iterable)",bottom:"",init:"iterable",loop:"",top:"",useHas:!0,useKeys:!!lb},d=0;a=arguments[d];d++)for(var e in a)b[e]=a[e];var f=b.args;b.firstArg=/^[^,]+/.exec(f)[0];var g=Function("hasOwnProperty, isArguments, isArray, isString, keys, lodash, objectTypes","return function("+f+") {\n"+gb(b)+"\n}");return g(W,j,l,p,lb,c,P)}function f(a){return"function"!=typeof a.toString&&"string"==typeof(a+"")}function g(){}function h(a){var b=!1;if(!a||Y.call(a)!=L||!fb.argsClass&&j(a))return b;var c=a.constructor;return(n(c)?c instanceof c:fb.nodeClass||!f(a))?fb.ownLast?(ob(a,function(a,c,d){return b=W.call(d,c),!1}),b===!0):(ob(a,function(a,c){b=c}),b===!1||W.call(a,b)):b}function i(a,b,c){b||(b=0),"undefined"==typeof c&&(c=a?a.length:0);for(var d=-1,e=c-b||0,f=Array(0>e?0:e);++d<e;)f[d]=a[b+d];return f}function j(a){return Y.call(a)==F}function k(a,b,d,e,g,h){var j=a;if("function"==typeof b&&(e=d,d=b,b=!1),"function"==typeof d){if(d="undefined"==typeof e?d:c.createCallback(d,e,1),j=d(j),"undefined"!=typeof j)return j;j=a}var m=o(j);if(m){var n=Y.call(j);if(!O[n]||!fb.nodeClass&&f(j))return j;var p=l(j)}if(!m||!b)return m?p?i(j):nb({},j):j;var r=eb[n];switch(n){case H:case I:return new r(+j);case K:case N:return new r(j);case M:return r(j.source,D.exec(j))}g||(g=[]),h||(h=[]);for(var s=g.length;s--;)if(g[s]==a)return h[s];return j=p?r(j.length):{},p&&(W.call(a,"index")&&(j.index=a.index),W.call(a,"input")&&(j.input=a.input)),g.push(a),h.push(j),(p?q:pb)(a,function(a,c){j[c]=k(a,b,d,z,g,h)}),j}function l(a){return fb.argsObject&&a instanceof Array||($?$(a):Y.call(a)==G)}function m(a,b,d,e,g,h){var i=d===C;if("function"==typeof d&&!i){d=c.createCallback(d,e,2);var k=d(a,b);if("undefined"!=typeof k)return!!k}if(a===b)return 0!==a||1/a==1/b;var l=typeof a,o=typeof b;if(a===a&&(!a||"function"!=l&&"object"!=l)&&(!b||"function"!=o&&"object"!=o))return!1;if(null==a||null==b)return a===b;var p=Y.call(a),q=Y.call(b);if(p==F&&(p=L),q==F&&(q=L),p!=q)return!1;switch(p){case H:case I:return+a==+b;case K:return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case M:case N:return a==String(b)}var r=p==G;if(!r){if(W.call(a,"__wrapped__ ")||W.call(b,"__wrapped__"))return m(a.__wrapped__||a,b.__wrapped__||b,d,e,g,h);if(p!=L||!fb.nodeClass&&(f(a)||f(b)))return!1;var s=!fb.argsObject&&j(a)?Object:a.constructor,t=!fb.argsObject&&j(b)?Object:b.constructor;if(s!=t&&!(n(s)&&s instanceof s&&n(t)&&t instanceof t))return!1}g||(g=[]),h||(h=[]);for(var u=g.length;u--;)if(g[u]==a)return h[u]==b;var v=0;if(k=!0,g.push(a),h.push(b),r){if(u=a.length,v=b.length,k=v==a.length,!k&&!i)return k;for(;v--;){var w=u,x=b[v];if(i)for(;w--&&!(k=m(a[w],x,d,e,g,h)););else if(!(k=m(a[v],x,d,e,g,h)))break}return k}return ob(b,function(b,c,f){return W.call(f,c)?(v++,k=W.call(a,c)&&m(a[c],b,d,e,g,h)):void 0}),k&&!i&&ob(a,function(a,b,c){return W.call(c,b)?k=--v>-1:void 0}),k}function n(a){return"function"==typeof a}function o(a){return a?P[typeof a]:!1}function p(a){return"string"==typeof a||Y.call(a)==N}function q(a,b,c){if(b&&"undefined"==typeof c&&l(a))for(var d=-1,e=a.length;++d<e&&b(a[d],d,a)!==!1;);else mb(a,b,c);return a}function r(a){var b=-1,c=a?a.length:0,d=Array("number"==typeof c?c:0);return q(a,function(a){var c=U(ab()*(++b+1));d[b]=d[c],d[c]=a}),d}function s(a,b,d,e){var f=0,g=a?a.length:f;for(d=d?c.createCallback(d,e,1):w,b=d(b);g>f;){var h=f+g>>>1;d(a[h])<b?f=h+1:g=h}return f}function t(a,b){return fb.fastBind||Z&&arguments.length>2?Z.call.apply(Z,arguments):d(a,b,bb.call(arguments,2))}function u(a,b,c){if(null==a)return w;var d=typeof a;if("function"!=d){if("object"!=d)return function(b){return b[a]};var e=lb(a);return function(b){for(var c=e.length,d=!1;c--&&(d=m(b[e[c]],a[e[c]],C)););return d}}return"undefined"!=typeof b?1===c?function(c){return a.call(b,c)}:2===c?function(c,d){return a.call(b,c,d)}:4===c?function(c,d,e,f){return a.call(b,c,d,e,f)}:function(c,d,e){return a.call(b,c,d,e)}:a}function v(a,b,c){function d(){i=new Date,h=null,k&&(f=a.apply(g,e))}var e,f,g,h,i=0,j=!0,k=!0;return c===!1?j=!1:c&&P[typeof c]&&(j="leading"in c?c.leading:j,k="trailing"in c?c.trailing:k),function(){var c=new Date;h||j||(i=c);var k=b-(c-i);return e=arguments,g=this,0>=k?(T(h),h=null,i=c,f=a.apply(g,e)):h||(h=X(d,k)),f}}function w(a){return a}function x(a,b){return null==a&&null==b&&(b=1),a=+a||0,null==b&&(b=a,a=0),a+U(ab()*((+b||0)-a+1))}function y(a){var b=++B;return String(null==a?"":a)+b}var z,A="object"==typeof global&&global;(A.global===A||A.window===A)&&(b=A);var B=0,C={};+new Date+"";var D=/\w*$/,E=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],F="[object Arguments]",G="[object Array]",H="[object Boolean]",I="[object Date]",J="[object Function]",K="[object Number]",L="[object Object]",M="[object RegExp]",N="[object String]",O={};O[J]=!1,O[F]=O[G]=O[H]=O[I]=O[K]=O[L]=O[M]=O[N]=!0;var P={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},Q=Array(),R=Object();b._;var S=RegExp("^"+String(R.valueOf).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),T=(Math.ceil,b.clearTimeout),U=(Q.concat,Math.floor),V=S.test(V=Object.getPrototypeOf)&&V,W=R.hasOwnProperty,X=(Q.push,b.setTimeout),Y=R.toString,Z=S.test(Z=Y.bind)&&Z,$=S.test($=Array.isArray)&&$,_=(b.isFinite,b.isNaN,S.test(_=Object.keys)&&_),ab=(Math.max,Math.min,Math.random),bb=Q.slice,cb=S.test(b.attachEvent),db=Z&&!/\n|true/.test(Z+cb),eb={};eb[G]=Array,eb[H]=Boolean,eb[I]=Date,eb[L]=Object,eb[K]=Number,eb[M]=RegExp,eb[N]=String;var fb=c.support={};!function(){var a=function(){this.x=1},b=[];a.prototype={valueOf:1,y:1};for(var c in new a)b.push(c);for(c in arguments);fb.argsObject=arguments.constructor==Object&&!(arguments instanceof Array),fb.argsClass=j(arguments),fb.enumPrototypes=a.propertyIsEnumerable("prototype"),fb.fastBind=Z&&!db,fb.ownLast="x"!=b[0],fb.nonEnumArgs=0!=c,fb.nonEnumShadows=!/valueOf/.test(b),fb.unindexedChars="xx"!="x"[0]+Object("x")[0];try{fb.nodeClass=!(Y.call(document)==L&&!({toString:0}+""))}catch(d){fb.nodeClass=!0}}(1);var gb=function(a){var b="var index, iterable = "+a.firstArg+", result = "+a.init+";\nif (!iterable) return result;\n"+a.top+";\n";if(a.arrays?(b+="var length = iterable.length; index = -1;\nif ("+a.arrays+") {  ",fb.unindexedChars&&(b+="\n  if (isString(iterable)) {\n    iterable = iterable.split('')\n  }  "),b+="\n  while (++index < length) {\n    "+a.loop+"\n  }\n}\nelse {  "):fb.nonEnumArgs&&(b+="\n  var length = iterable.length; index = -1;\n  if (length && isArguments(iterable)) {\n    while (++index < length) {\n      index += '';\n      "+a.loop+"\n    }\n  } else {  "),fb.enumPrototypes&&(b+="\n  var skipProto = typeof iterable == 'function';\n  "),a.useHas&&a.useKeys)b+="\n  var ownIndex = -1,\n      ownProps = objectTypes[typeof iterable] ? keys(iterable) : [],\n      length = ownProps.length;\n\n  while (++ownIndex < length) {\n    index = ownProps[ownIndex];\n    ",fb.enumPrototypes&&(b+="if (!(skipProto && index == 'prototype')) {\n  "),b+=a.loop,fb.enumPrototypes&&(b+="}\n"),b+="  }  ";else if(b+="\n  for (index in iterable) {",(fb.enumPrototypes||a.useHas)&&(b+="\n    if (",fb.enumPrototypes&&(b+="!(skipProto && index == 'prototype')"),fb.enumPrototypes&&a.useHas&&(b+=" && "),a.useHas&&(b+="hasOwnProperty.call(iterable, index)"),b+=") {    "),b+=a.loop+";    ",(fb.enumPrototypes||a.useHas)&&(b+="\n    }"),b+="\n  }    ",fb.nonEnumShadows){b+="\n\n  var ctor = iterable.constructor;\n      ";for(var c=0;7>c;c++)b+="\n  index = '"+a.shadowedProps[c]+"';\n  if (","constructor"==a.shadowedProps[c]&&(b+="!(ctor && ctor.prototype === iterable) && "),b+="hasOwnProperty.call(iterable, index)) {\n    "+a.loop+"\n  }      "}return(a.arrays||fb.nonEnumArgs)&&(b+="\n}"),b+=a.bottom+";\nreturn result"},hb={args:"object, source, guard",top:"var args = arguments,\n    argsIndex = 0,\n    argsLength = typeof guard == 'number' ? 2 : args.length;\nwhile (++argsIndex < argsLength) {\n  iterable = args[argsIndex];\n  if (iterable && objectTypes[typeof iterable]) {",loop:"if (typeof result[index] == 'undefined') result[index] = iterable[index]",bottom:"  }\n}"},ib={args:"collection, callback, thisArg",top:"callback = callback && typeof thisArg == 'undefined' ? callback : lodash.createCallback(callback, thisArg)",arrays:"typeof length == 'number'",loop:"if (callback(iterable[index], index, collection) === false) return result"},jb={top:"if (!objectTypes[typeof iterable]) return result;\n"+ib.top,arrays:!1};fb.argsClass||(j=function(a){return a?W.call(a,"callee"):!1});var kb=e({args:"object",init:"[]",top:"if (!(objectTypes[typeof object])) return result",loop:"result.push(index)",arrays:!1}),lb=_?function(a){return o(a)?fb.enumPrototypes&&"function"==typeof a||fb.nonEnumArgs&&a.length&&j(a)?kb(a):_(a):[]}:kb,mb=e(ib),nb=e(hb,{top:hb.top.replace(";",";\nif (argsLength > 3 && typeof args[argsLength - 2] == 'function') {\n  var callback = lodash.createCallback(args[--argsLength - 1], args[argsLength--], 2);\n} else if (argsLength > 2 && typeof args[argsLength - 1] == 'function') {\n  callback = args[--argsLength];\n}"),loop:"result[index] = callback ? callback(result[index], iterable[index]) : iterable[index]"}),ob=e(ib,jb,{useHas:!1}),pb=e(ib,jb);n(/x/)&&(n=function(a){return a instanceof Function||Y.call(a)==J});var qb=V?function(a){if(!a||Y.call(a)!=L||!fb.argsClass&&j(a))return!1;var b=a.valueOf,c="function"==typeof b&&(c=V(b))&&V(c);return c?a==c||V(a)==c:h(a)}:h;c.assign=nb,c.bind=t,c.createCallback=u,c.forEach=q,c.forIn=ob,c.forOwn=pb,c.keys=lb,c.shuffle=r,c.throttle=v,c.each=q,c.extend=nb,c.clone=k,c.identity=w,c.isArguments=j,c.isArray=l,c.isEqual=m,c.isFunction=n,c.isObject=o,c.isPlainObject=qb,c.isString=p,c.random=x,c.sortedIndex=s,c.uniqueId=y,c.VERSION="1.2.0",c.extend(a.util,c)}(this);var b=a.util.decorator=function(b,c){var d={},e={},f=function(b,c){return a.util.isFunction(c)?c:b},g=Object.getPrototypeOf;"function"!=typeof g&&(g="object"==typeof"test".__proto__?function(a){return a.__proto__}:function(a){return a.constructor.prototype});var h=Object.create;"function"!=typeof h&&(h=function(a){function b(){}return b.prototype=a,new b});var i=function(c,d){return"object"==typeof c?(e=a.util.extend(e,c,f),e.type=b,void 0):("type"!==c&&a.util.isFunction(d)&&(e[c]=d),void 0)};i(c);var j=function(c,i,j,k){var l,m=e;if("string"!=typeof i)k=j,j=i;else{if(m=d[i],!m)throw'Error: "'+i+'" '+b+" not defined";m=m.prototype}if("function"==typeof j)l=d[c],l?l.prototype=a.util.extend(l.prototype,j(g(l.prototype)),f):(l=d[c]=function(a){this.init&&this.init(a)},l.prototype=h(m),l.prototype=a.util.extend(l.prototype,j(m),f)),l.prototype.type=b,l.prototype.name=c;else if(k=j||{},l=d[c],!l)throw'Error: "'+c+'" '+b+" not defined";return k?new l(k):void 0};return j.mixin=i,j};return function(b){var c=b.Physics;a.noConflict=function(){return b.Physics===a&&(b.Physics=c),a}}(this),function(){var b=function c(a){return this instanceof c?(this._topics={},this.defaultScope=a||this,void 0):new c(a)};b.prototype={subscribe:function(b,c,d,e){var f,g=this._topics[b]||(this._topics[b]=[]),h=c;if(a.util.isObject(b)){for(var i in b)this.subscribe(i,b[i],c,d);return this}return a.util.isObject(d)?(c=a.util.bind(c,d),c._bindfn_=h):e=d,c._priority_=e,f=a.util.sortedIndex(g,c,"_priority_"),g.splice(f,0,c),this},unsubscribe:function(a,b){var c,d=this._topics[a];if(!d)return this;for(var e=0,f=d.length;f>e;e++)if(c=d[e],c._bindfn_===b||c===b){d.splice(e,1);break}return this},publish:function(a){"object"!=typeof a&&(a={topic:a});var b=a.topic,c=this._topics[b],d=c&&c.length;if(!b)throw"Error: No topic specified in call to world.publish()";if(!d)return this;for(a.scope=a.scope||this.defaultScope;d--;)a.handler=c[d],a.handler(a);return this}},a.util.pubsub=b}(),function(a){for(var b=0,c=["ms","moz","webkit","o"],d=0;d<c.length&&!a.requestAnimationFrame;++d)a.requestAnimationFrame=a[c[d]+"RequestAnimationFrame"],a.cancelAnimationFrame=a[c[d]+"CancelAnimationFrame"]||a[c[d]+"CancelRequestAnimationFrame"];a.requestAnimationFrame||(a.requestAnimationFrame=function(c){var d=(new Date).getTime(),e=Math.max(0,16-(d-b)),f=a.setTimeout(function(){c(d+e)},e);return b=d+e,f}),a.cancelAnimationFrame||(a.cancelAnimationFrame=function(a){clearTimeout(a)})}(this),function(){var b=100,c=10,d="Error: Scratchpad used after .done() called. (Could it be unintentionally scoped?)",e="Error: Scratchpad usage space out of bounds. (Did you forget to call .done()?)",f="Error: Too many scratchpads created. (Did you forget to call .done()?)",g=[],h=0,i=function(){if(this.objIndex=0,this.arrayIndex=0,this.vectorIndex=0,this.aabbIndex=0,this.transformIndex=0,this.objectStack=[],this.arrayStack=[],this.vectorStack=[],this.aabbStack=[],this.transformStack=[],++h>=b)throw f};i.prototype={done:function(){this._active=!1,this.objIndex=this.arrayIndex=this.vectorIndex=this.aabbIndex=this.transformIndex=0,g.push(this)},object:function(){var a=this.objectStack;if(!this._active)throw d;if(this.objIndex>=c)throw e;return a[this.objIndex++]||a[a.push({})-1]},array:function(){var a=this.arrayStack;if(!this._active)throw d;if(this.arrIndex>=c)throw e;return a[this.arrIndex++]||a[a.push([])-1]},vector:function(){var b=this.vectorStack;if(!this._active)throw d;if(this.vectorIndex>=c)throw e;return b[this.vectorIndex++]||b[b.push(a.vector())-1]},aabb:function(){var b=this.aabbStack;if(!this._active)throw d;if(this.aabbIndex>=c)throw e;return b[this.aabbIndex++]||b[b.push(a.aabb())-1]},transform:function(){var b=this.transformStack;if(!this._active)throw d;if(this.transformIndex>=c)throw e;return b[this.transformIndex++]||b[b.push(a.transform())-1]}},a.scratchpad=function(){var a=g.pop()||new i;return a._active=!0,a}}(),function(b){function c(a){var d=k;if(j){b.requestAnimationFrame(c);for(var e=0,f=d.length;f>e;++e)d[e](a,a-i);i=a}}function d(){return i=(new Date).getTime(),j=!0,c(),this}function e(){return j=!1,this}function f(a){if("function"==typeof a){for(var b=0,c=k.length;c>b;++b)if(a===k[b])return this;k.push(a)}return this}function g(a){for(var b=k,c=0,d=b.length;d>c;++c)if(b[c]===a)return b.splice(c,1),this;return this}function h(){return!!j}var i=0,j=!1,k=[];a.util.ticker={start:d,stop:e,subscribe:f,unsubscribe:g,isActive:h}}(this),function(){var b=function c(b,d,e,f){return this instanceof c?(this._pos=a.vector(),this.set(b,d,e,f),void 0):new c(b,d,e,f)};b.prototype.set=function(b,c,d,e){return a.util.isObject(b)?(this._pos.clone(b.pos),this._hw=b.halfWidth,this._hh=b.halfHeight,this):(this._pos.set(.5*(d+b),.5*(e+c)),this._hw=.5*(d-b),this._hh=.5*(e-c),this)},b.prototype.get=function(){var a=this.halfWidth(),b=this.halfHeight();return{pos:this._pos.values(),halfWidth:a,halfHeight:b,x:a,y:b}},b.prototype.halfWidth=function(){return this._hw},b.prototype.halfHeight=function(){return this._hh},b.prototype.contains=function(a){var b=void 0!==a.x?a.x:a.get(0),c=void 0!==a.y?a.y:a.get(1);return b>this._pos.get(0)-this._hw&&b<this._pos.get(0)+this._hw&&c>this._pos.get(1)-this._hh&&c<this._pos.get(1)+this._hh},b.prototype.transform=function(b){var c=this._hw,d=this._hh,e=a.scratchpad(),f=e.vector().set(c,d),g=e.vector().set(c,-d);return this._pos.translate(b),f.rotate(b),g.rotate(b),this._hw=Math.max(Math.abs(f.get(0)),Math.abs(g.get(0))),this._hh=Math.max(Math.abs(f.get(1)),Math.abs(g.get(1))),e.done(),this},b.contains=function(a,b){var c=void 0!==b.x?b.x:b.get(0),d=void 0!==b.y?b.y:b.get(1);return a=a.get?a.get():a,c>a.pos.x-a.halfWidth&&c<a.pos.x+a.halfWidth&&d>a.pos.y-a.halfHeight&&d<a.pos.y+a.halfHeight},a.aabb=b}(),function(){var b=1e-4,c=100,d=function(a,b,c){var d=b.normSq()-b.dot(a),e=b.dot(a)-a.normSq();return 0>d?c.clone(b).negate():e>0?c.clone(a).negate():(c.clone(b).vsub(a),c.perp(a.cross(c)<0))},e=function(b){var c,d,e=b.length,f=b[e-2],g=b[e-3],h=a.scratchpad(),i=h.vector().clone(f.pt),j=h.vector().clone(g.pt).vsub(i);if(j.equals(a.vector.zero))return h.done(),{a:f.a,b:f.b};if(c=-j.dot(i)/j.normSq(),d=1-c,0>=d)return h.done(),{a:g.a,b:g.b};if(0>=c)return h.done(),{a:f.a,b:f.b};var k={a:i.clone(f.a).mult(d).vadd(j.clone(g.a).mult(c)).values(),b:i.clone(f.b).mult(d).vadd(j.clone(g.b).mult(c)).values()};return h.done(),k},f=function(f,g,h,i){var j,k,l,m,n=!1,o=!1,p=!1,q=[],r=1,s=a.scratchpad(),t=s.vector().clone(g||a.vector.axis[0]),u=s.vector(),v=s.vector(),w=s.vector(),x=s.vector(),y=0;for(m=f(t),r=q.push(m),u.clone(m.pt),t.negate();++y;){if(u.swap(v),m=f(t),r=q.push(m),u.clone(m.pt),i&&i(q),u.equals(a.vector.zero)){n=!0;break}if(!o&&u.dot(t)<=0){if(h)break;o=!0}if(2===r)t=d(u,v,t);else if(o){if(t.normalize(),m=v.dot(t),Math.abs(m-u.dot(t))<b){p=-m;break}v.normSq()<w.clone(q[0].pt).normSq()?q.shift():q.splice(1,1),t=d(w.clone(q[1].pt),x.clone(q[0].pt),t)}else if(j=j||s.vector(),k=k||s.vector(),j.clone(v).vsub(u),k.clone(q[0].pt).vsub(u),l=j.cross(k)>0,l^u.cross(j)>0)q.shift(),j.perp(l),t.swap(j);else{if(!(l^k.cross(u)>0)){n=!0;break}q.splice(1,1),k.perp(!l),t.swap(j)}if(y>c)return s.done(),{simplex:q,iterations:y,distance:0,maxIterationsReached:!0}}return s.done(),m={overlap:n,simplex:q,iterations:y},p!==!1&&(m.distance=p,m.closest=e(q)),m};a.gjk=f}(),function(){var b=function c(b,d){return this instanceof c?(this.v=a.vector(),this.angle=0,b instanceof c&&this.clone(b),b&&this.setTranslation(b),this.setRotation(d||0),void 0):new c(b,d)};b.prototype.setTranslation=function(a){return this.v.clone(a),this},b.prototype.setRotation=function(a){return this.angle=0,this.cosA=Math.cos(a),this.sinA=Math.sin(a),this},b.prototype.clone=function(a){return a?(this.setTranslation(a.v),this.setRotation(a.angle),this):new b(this)},a.transform=b}(),function(b){var c=Math.sqrt,d=Math.min,e=Math.max,f=(Math.acos,Math.atan2),g=2*Math.PI,h=!!b.Float64Array,i=function j(a,b){return this instanceof j?(this._=h?new Float64Array(5):[],a&&(void 0!==a.x||a._&&a._.length)?this.clone(a):(this.recalc=!0,this.set(a||0,b||0)),void 0):new j(a,b)};i.prototype.set=function(a,b){return this.recalc=!0,this._[0]=a||0,this._[1]=b||0,this},i.prototype.get=function(a){return this._[a]},i.prototype.vadd=function(a){return this.recalc=!0,this._[0]+=a._[0],this._[1]+=a._[1],this},i.prototype.vsub=function(a){return this.recalc=!0,this._[0]-=a._[0],this._[1]-=a._[1],this},i.prototype.add=function(a,b){return this.recalc=!0,this._[0]+=a,this._[1]+=void 0===b?a:b,this},i.prototype.sub=function(a,b){return this.recalc=!0,this._[0]-=a,this._[1]-=void 0===b?a:b,this},i.prototype.mult=function(a){return this.recalc||(this._[4]*=a*a,this._[3]*=a),this._[0]*=a,this._[1]*=a,this},i.prototype.dot=function(a){return this._[0]*a._[0]+this._[1]*a._[1]},i.prototype.cross=function(a){return-this._[0]*a._[1]+this._[1]*a._[0]},i.prototype.proj=function(a){return this.dot(a)/a.norm()},i.prototype.vproj=function(a){var b=this.dot(a)/a.normSq();return this.clone(a).mult(b)},i.prototype.angle=function(a){var b=f(this._[1],this._[0]);for(a&&(b-=f(a._[1],a._[0]));b>Math.PI;)b-=g;for(;b<-Math.PI;)b+=g;return b},i.prototype.norm=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=c(this._[4])),this._[3]},i.prototype.normSq=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=c(this._[4])),this._[4]},i.prototype.dist=function(a){var b,d;return c((b=a._[0]-this._[0])*b+(d=a._[1]-this._[1])*d)},i.prototype.distSq=function(a){var b,c;return(b=a._[0]-this._[0])*b+(c=a._[1]-this._[1])*c},i.prototype.perp=function(a){var b=this._[0];return a?(this._[0]=-this._[1],this._[1]=b):(this._[0]=this._[1],this._[1]=-b),this},i.prototype.normalize=function(){var a=this.norm();return 0===a?this:(this._[0]/=a,this._[1]/=a,this._[3]=1,this._[4]=1,this)},i.prototype.transform=function(a){return this.set(this._[0]*a.cosA-this._[1]*a.sinA+a.v._[0],this._[0]*a.sinA+this._[1]*a.cosA+a.v._[1])},i.prototype.transformInv=function(a){return this.set(this._[0]*a.cosA+this._[1]*a.sinA-a.v._[0],-this._[0]*a.sinA+this._[1]*a.cosA-a.v._[1])},i.prototype.rotate=function(a){return this.set(this._[0]*a.cosA-this._[1]*a.sinA,this._[0]*a.sinA+this._[1]*a.cosA)},i.prototype.rotateInv=function(a){return this.set(this._[0]*a.cosA+this._[1]*a.sinA,-this._[0]*a.sinA+this._[1]*a.cosA)},i.prototype.translate=function(a){return this.vadd(a.v)},i.prototype.translateInv=function(a){return this.vsub(a.v)},i.prototype.clone=function(a){return a?a._?(this.recalc=a.recalc,a.recalc||(this._[3]=a._[3],this._[4]=a._[4]),this._[0]=a._[0],this._[1]=a._[1],this):this.set(a.x,a.y):new i(this)},i.prototype.swap=function(a){var b=this._;return this._=a._,a._=b,b=this.recalc,this.recalc=a.recalc,a.recalc=b,this},i.prototype.values=function(){return{x:this._[0],y:this._[1]}},i.prototype.zero=function(){return this._[3]=0,this._[4]=0,this._[0]=0,this._[1]=0,this},i.prototype.negate=function(a){return void 0!==a?(this._[a]=-this._[a],this):(this._[0]=-this._[0],this._[1]=-this._[1],this)},i.prototype.clamp=function(a,b){return a=a.values?a.values():a,b=b.values?b.values():b,this._[0]=d(e(this._[0],a.x),b.x),this._[1]=d(e(this._[1],a.y),b.y),this.recalc=!0,this},i.prototype.toString=function(){return"("+this._[0]+", "+this._[1]+")"},i.prototype.equals=function(a){return this._[0]===a._[0]&&this._[1]===a._[1]&&this._[2]===a._[2]},i.vadd=function(a,b){return new i(a._[0]+b._[0],a._[1]+b._[1])},i.vsub=function(a,b){return new i(a._[0]-b._[0],a._[1]-b._[1])},i.mult=function(a,b){return new i(b._[0]*a,b._[1]*a)},i.vproj=function(a,b){return i.mult(a.dot(b)/b.normSq(),b)},i.axis=[new i(1,0),new i(0,1)],i.zero=new i(0,0),a.vector=i}(this),function(){a.behavior=a.behaviour=b("behavior",{priority:0,init:function(){this.options={}},connect:function(a){this.behave&&a.subscribe("integrate:positions",this.behave,this,this.priority)},disconnect:function(a){this.behave&&a.unsubscribe("integrate:positions",this.behave)},behave:null})}(),function(){var c={fixed:!1,mass:1,restitution:1,cof:.8,view:null};a.body=b("body",{init:function(b){var d=a.vector;if(this.options=a.util.extend({},c,b),this.fixed=this.options.fixed,this.hidden=this.options.hidden,this.mass=this.options.mass,this.restitution=this.options.restitution,this.cof=this.options.cof,this.view=this.options.view,this.state={pos:d(b.x,b.y),vel:d(b.vx,b.vy),acc:d(),angular:{pos:b.angle||0,vel:b.angularVelocity||0,acc:0},old:{pos:d(),vel:d(),acc:d(),angular:{pos:0,vel:0,acc:0}}},0===this.mass)throw"Error: Bodies must have non-zero mass";this.geometry=a.geometry("point")},accelerate:function(a){return this.state.acc.vadd(a),this},applyForce:function(b,c){var d,e=a.scratchpad(),f=e.vector();return c?this.moi&&(d=this.state,f.clone(c),this.state.angular.acc-=f.cross(b)/this.moi,this.applyForce(b)):this.accelerate(f.clone(b).mult(1/this.mass)),e.done(),this},aabb:function(){var b=a.scratchpad(),c=b.transform(),d=this.state.angular.pos,e=b.aabb().set(this.geometry.aabb(d));return c.setRotation(0).setTranslation(this.state.pos),e.transform(c),e=e.get(),b.done(),e},recalc:function(){}})}(),function(){a.geometry=b("geometry",{init:function(){this._aabb=new a.aabb},aabb:function(){return this._aabb.get()},getFarthestHullPoint:function(b,c){return c=c||a.vector(),c.set(0,0)},getFarthestCorePoint:function(b,c){return c=c||a.vector(),c.set(0,0)}})}(),a.geometry.isPolygonConvex=function(b){var c=a.scratchpad(),d=c.vector(),e=c.vector(),f=c.vector(),g=!0,h=!1,i=b.length;if(3>i)return c.done(),g;d.clone(b[0]).vsub(f.clone(b[i-1]));for(var j=1;i>=j;++j){if(e.clone(b[j%i]).vsub(f.clone(b[(j-1)%i])),h===!1)h=d.cross(e);else if(h>0^d.cross(e)>0){g=!1;break}e.swap(d)}return c.done(),g},a.geometry.getPolygonMOI=function(b){var c,d=a.scratchpad(),e=d.vector(),f=d.vector(),g=0,h=0,i=b.length;if(2>i)return d.done(),0;if(2===i)return c=f.clone(b[1]).distSq(e.clone(b[0])),d.done(),c/12;e.clone(b[0]);for(var j=1;i>j;++j)f.clone(b[j]),c=Math.abs(f.cross(e)),g+=c*(f.normSq()+f.dot(e)+e.normSq()),h+=c,e.swap(f);return d.done(),g/(6*h)},a.geometry.isPointInPolygon=function(b,c){var d=a.scratchpad(),e=d.vector().clone(b),f=d.vector(),g=d.vector(),h=0,i=c.length;if(2>i)return h=e.equals(f.clone(c[0])),d.done(),h;if(2===i)return h=e.angle(f.clone(c[0])),h+=e.angle(f.clone(c[1])),d.done(),Math.abs(h)===Math.PI;f.clone(c[0]).vsub(e);for(var j=1;i>=j;++j)g.clone(c[j%i]).vsub(e),h+=g.angle(f),f.swap(g);return d.done(),Math.abs(h)>0},a.geometry.getPolygonArea=function(b){var c=a.scratchpad(),d=c.vector(),e=c.vector(),f=0,g=b.length;if(3>g)return c.done(),0;d.clone(b[g-1]);for(var h=0;g>h;++h)e.clone(b[h]),f+=d.cross(e),d.swap(e);return c.done(),f/2},a.geometry.getPolygonCentroid=function(b){var c,d=a.scratchpad(),e=d.vector(),f=d.vector(),g=a.vector(),h=b.length;if(2>h)return d.done(),a.vector(b[0]);if(2===h)return d.done(),a.vector((b[1].x+b[0].x)/2,(b[1].y+b[0].y)/2);e.clone(b[h-1]);for(var i=0;h>i;++i)f.clone(b[i]),c=e.cross(f),e.vadd(f).mult(c),g.vadd(e),e.swap(f);return c=1/(6*a.geometry.getPolygonArea(b)),d.done(),g.mult(c)},a.geometry.nearestPointOnLine=function(b,c,d){var e,f,g=a.scratchpad(),h=g.vector().clone(b),i=g.vector().clone(c).vsub(h),j=g.vector().clone(d).vsub(h).vsub(i);return j.equals(a.vector.zero)?(g.done(),a.vector(c)):(e=-j.dot(i)/j.normSq(),f=1-e,0>=f?(g.done(),a.vector(d)):0>=e?(g.done(),a.vector(c)):(h=a.vector(d).mult(e).vadd(i.clone(c).mult(f)),g.done(),h))},function(){var c={drag:0};a.integrator=b("integrator",{init:function(b){this.options=a.util.extend({},c,b)},integrate:function(a,b){var c=this._world;return this.integrateVelocities(a,b),c&&c.publish({topic:"integrate:velocities",bodies:a,dt:b}),this.integratePositions(a,b),c&&c.publish({topic:"integrate:positions",bodies:a,dt:b}),this},integrateVelocities:function(){throw"The integrator.integrateVelocities() method must be overriden"},integratePositions:function(){throw"The integrator.integratePositions() method must be overriden"}})}(),function(){var c={meta:!1,metaRefresh:200,width:600,height:600};a.renderer=b("renderer",{init:function(b){var d="string"==typeof b.el?document.getElementById(b.el):b.el;this.options=a.util.extend({},c,b),this.el=d?d:document.body,this.drawMeta=a.util.throttle(a.util.bind(this.drawMeta,this),this.options.metaRefresh)},render:function(a,b){var c,d;this.beforeRender&&this.beforeRender(),this.options.meta&&this.drawMeta(b);for(var e=0,f=a.length;f>e;++e)c=a[e],d=c.view||(c.view=this.createView(c.geometry)),c.hidden||this.drawBody(c,d);return this},createView:function(){throw"You must overried the renderer.createView() method."},drawMeta:function(){throw"You must overried the renderer.drawMeta() method."},drawBody:function(){throw"You must overried the renderer.drawBody() method."}})}(),function(){var b=function(a){this.disconnect&&this._world&&this.disconnect(this._world),this._world=a,this.connect&&a&&this.connect(a)};a.util.each("body,behavior,integrator,renderer".split(","),function(c){a[c].mixin("setWorld",b)});var c={timestep:6.25,maxIPF:16,webworker:!1,integrator:"verlet"},d=function e(a,b){return this instanceof e?(this.init(a,b),void 0):new e(a,b)};d.prototype={init:function(b,c){a.util.isFunction(b)&&(c=b,b={}),this._stats={fps:0,ipf:0},this._bodies=[],this._behaviors=[],this._integrator=null,this._renderer=null,this._paused=!1,this._opts={},this._pubsub=a.util.pubsub(this),this.options(b||{}),a.util.isFunction(c)&&c.call(this,this,a)},options:function(b){return b?(a.util.extend(this._opts,c,b),this.timeStep(this._opts.timestep),this.add(a.integrator(this._opts.integrator)),this):a.util.clone(this._opts)},subscribe:function(a,b,c,d){return this._pubsub.subscribe(a,b,c,d),this},unsubscribe:function(a,b){return this._pubsub.unsubscribe(a,b),this},publish:function(a,b){return this._pubsub.publish(a,b),this},add:function(a){var b,c=0,d=a&&a.length||0,e=d?a[0]:a;if(!e)return this;do{switch(e.type){case"behavior":this.addBehavior(e);break;case"integrator":this.integrator(e);break;case"renderer":this.renderer(e);break;case"body":this.addBody(e);break;default:throw"Error: failed to add item of type "+e.type+" to world"}b={topic:"add:"+e.type},b[e.type]=e,this.publish(b)}while(++c<d&&(e=a[c]));return this},integrator:function(a){return a?(this._integrator&&this._integrator.setWorld(null),this._integrator=a,this._integrator.setWorld(this),this):this._integrator},renderer:function(a){return a?(this._renderer&&this._renderer.setWorld(null),this._renderer=a,this._renderer.setWorld(this),this):this._renderer},timeStep:function(a){return a?(this._dt=a,this._maxJump=a*this._opts.maxIPF,this):this._dt},addBehavior:function(a){return a.setWorld(this),this._behaviors.push(a),this},removeBehavior:function(a){var b=this._behaviors;if(a)for(var c=0,d=b.length;d>c;++c)if(a===b[c]){b.splice(c,1);break}return this},addBody:function(a){return a.setWorld(this),this._bodies.push(a),this},getBodies:function(){return[].concat(this._bodies)},removeBody:function(a){var b=this._bodies;if(a)for(var c=0,d=b.length;d>c;++c)if(a===b[c]){b.splice(c,1);break}return this},findOne:function(b){var c={check:function(a){for(var b=this;b=b.next;)if(b(a))return!0;return!1}},d=c,e=this._bodies;b.$within,b.$at&&(d.next=function(c){var d=c.aabb();return a.aabb.contains(d,b.$at)});for(var f=0,g=e.length;g>f;++f)if(c.check(e[f]))return e[f];return!1},iterate:function(a){this._integrator.integrate(this._bodies,a)},step:function(a){if(this._paused)return this._time=!1,this;var b=this._time||(this._time=a),c=a-b,d=this._stats,e=this._dt;if(!c)return this;for(c>this._maxJump&&(this._time=a-this._maxJump,c=this._maxJump),d.fps=1e3/c,d.ipf=Math.ceil(c/this._dt);this._time<a;)this._time+=e,this.iterate(e);return this.publish({topic:"step"}),this},render:function(){if(!this._renderer)throw"No renderer added to world";return this._renderer.render(this._bodies,this._stats),this.publish({topic:"render",bodies:this._bodies,renderer:this._renderer}),this},pause:function(){return this._paused=!0,this.publish({topic:"pause"}),this},unpause:function(){return this._paused=!1,this.publish({topic:"unpause"}),this},isPaused:function(){return!!this._paused}},a.world=d}(),a.integrator("verlet",function(b){return a.body.mixin({started:function(a){return void 0!==a&&(this._started=!0),!!this._started}}),{init:function(a){b.init.call(this,a)},integrateVelocities:function(a,b){for(var c,d=b*b,e=1-this.options.drag,f=null,g=0,h=a.length;h>g;++g)f=a[g],c=f.state,f.fixed?(c.vel.zero(),c.acc.zero(),c.angular.vel=0,c.angular.acc=0):(c.vel.equals(c.old.vel)&&f.started()?c.vel.clone(c.pos).vsub(c.old.pos):(c.old.pos.clone(c.pos).vsub(c.vel),c.vel.mult(b)),e&&c.vel.mult(e),c.vel.vadd(c.acc.mult(d)),c.vel.mult(1/b),c.old.vel.clone(c.vel),c.acc.zero(),c.angular.vel===c.old.angular.vel&&f.started()?c.angular.vel=c.angular.pos-c.old.angular.pos:(c.old.angular.pos=c.angular.pos-c.angular.vel,c.angular.vel*=b),c.angular.vel+=c.angular.acc*d,c.angular.vel/=b,c.old.angular.vel=c.angular.vel,c.angular.acc=0,f.started(!0))},integratePositions:function(a,b){for(var c,d=null,e=0,f=a.length;f>e;++e)d=a[e],c=d.state,d.fixed||(c.vel.mult(b),c.old.pos.clone(c.pos),c.pos.vadd(c.vel),c.vel.mult(1/b),c.old.vel.clone(c.vel),c.angular.vel*=b,c.old.angular.pos=c.angular.pos,c.angular.pos+=c.angular.vel,c.angular.vel/=b,c.old.angular.vel=c.angular.vel)}}}),a.geometry("point",function(){}),a});