(function(t,e){"object"==typeof exports?module.exports=e.call(t):"function"==typeof define&&define.amd?define(function(){return e.call(t)}):t.Physics=e.call(t)})(this,function(){"use strict";var t=function t(){return t.world.apply(t,arguments)};t.util={},function(e){function n(){}function r(t,e,n,r){function i(){var r=arguments,l=a?this:e;if(o||(t=e[c]),n.length&&(r=r.length?(r=ee.call(r),u?r.concat(n):n.concat(r)):n),this instanceof i){s.prototype=t.prototype,l=new s,s.prototype=null;var h=t.apply(l,r);return d(h)?h:l}return t.apply(l,r)}var o=p(t),a=!n,c=e;if(a){var u=r;n=e}else if(!o){if(!r)throw new TypeError;e=t}return i}function i(){for(var t,e={shadowedProps:C,arrays:"isArray(iterable)",bottom:"",init:"iterable",loop:"",top:"",useHas:!0,useKeys:!!he},r=0;t=arguments[r];r++)for(var i in t)e[i]=t[i];var o=e.args;e.firstArg=/^[^,]+/.exec(o)[0];var s=Function("hasOwnProperty, isArguments, isArray, isString, keys, lodash, objectTypes","return function("+o+") {\n"+se(e)+"\n}");return s(K,u,h,v,he,n,z)}function o(t){return"function"!=typeof t.toString&&"string"==typeof(t+"")}function s(){}function a(t){var e=!1;if(!t||G.call(t)!=H||!oe.argsClass&&u(t))return e;var n=t.constructor;return(p(n)?n instanceof n:oe.nodeClass||!o(t))?oe.ownLast?(de(t,function(t,n,r){return e=K.call(r,n),!1}),e===!0):(de(t,function(t,n){e=n}),e===!1||K.call(t,e)):e}function c(t,e,n){e||(e=0),n===k&&(n=t?t.length:0);for(var r=-1,i=n-e||0,o=Array(0>i?0:i);i>++r;)o[r]=t[e+r];return o}function u(t){return G.call(t)==O}function l(t,e,r,i,s,a){var u=t;if("function"==typeof e&&(i=r,r=e,e=!1),"function"==typeof r){if(r=i===k?r:n.createCallback(r,i,1),u=r(u),u!==k)return u;u=t}var f=d(u);if(f){var p=G.call(u);if(!R[p]||!oe.nodeClass&&o(u))return u;var v=h(u)}if(!f||!e)return f?v?c(u):pe({},u):u;var b=ie[p];switch(p){case B:case q:return new b(+u);case T:case W:return new b(u);case L:return b(u.source,M.exec(u))}s||(s=[]),a||(a=[]);for(var y=s.length;y--;)if(s[y]==t)return a[y];return u=v?b(u.length):{},v&&(K.call(t,"index")&&(u.index=t.index),K.call(t,"input")&&(u.input=t.input)),s.push(t),a.push(u),(v?g:ve)(t,function(t,n){u[n]=l(t,e,r,k,s,a)}),u}function h(t){return oe.argsObject&&t instanceof Array||(X?X(t):G.call(t)==F)}function f(t,e,r,i,s,a){var c=r===S;if("function"==typeof r&&!c){r=n.createCallback(r,i,2);var l=r(t,e);if(l!==k)return!!l}if(t===e)return 0!==t||1/t==1/e;var h=typeof t,d=typeof e;if(t===t&&(!t||"function"!=h&&"object"!=h)&&(!e||"function"!=d&&"object"!=d))return!1;if(null==t||null==e)return t===e;var v=G.call(t),g=G.call(e);if(v==O&&(v=H),g==O&&(g=H),v!=g)return!1;switch(v){case B:case q:return+t==+e;case T:return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case L:case W:return t==e+""}var b=v==F;if(!b){if(K.call(t,"__wrapped__ ")||K.call(e,"__wrapped__"))return f(t.__wrapped__||t,e.__wrapped__||e,r,i,s,a);if(v!=H||!oe.nodeClass&&(o(t)||o(e)))return!1;var y=!oe.argsObject&&u(t)?Object:t.constructor,m=!oe.argsObject&&u(e)?Object:e.constructor;if(y!=m&&!(p(y)&&y instanceof y&&p(m)&&m instanceof m))return!1}s||(s=[]),a||(a=[]);for(var _=s.length;_--;)if(s[_]==t)return a[_]==e;var x=0;if(l=!0,s.push(t),a.push(e),b){if(_=t.length,x=e.length,l=x==t.length,!l&&!c)return l;for(;x--;){var w=_,A=e[x];if(c)for(;w--&&!(l=f(t[w],A,r,i,s,a)););else if(!(l=f(t[x],A,r,i,s,a)))break}return l}return de(e,function(e,n,o){return K.call(o,n)?(x++,l=K.call(t,n)&&f(t[n],e,r,i,s,a)):k}),l&&!c&&de(t,function(t,e,n){return K.call(n,e)?l=--x>-1:k}),l}function p(t){return"function"==typeof t}function d(t){return t?z[typeof t]:!1}function v(t){return"string"==typeof t||G.call(t)==W}function g(t,e,n){if(e&&n===k&&h(t))for(var r=-1,i=t.length;i>++r&&e(t[r],r,t)!==!1;);else fe(t,e,n);return t}function b(t){var e=-1,n=t?t.length:0,r=Array("number"==typeof n?n:0);return g(t,function(t){var n=J(te()*(++e+1));r[e]=r[n],r[n]=t}),r}function y(t,e,r,i){var o=0,s=t?t.length:o;for(r=r?n.createCallback(r,i,1):w,e=r(e);s>o;){var a=o+s>>>1;e>r(t[a])?o=a+1:s=a}return o}function m(t,e){return oe.fastBind||Q&&arguments.length>2?Q.call.apply(Q,arguments):r(t,e,ee.call(arguments,2))}function _(t,e,n){if(null==t)return w;var r=typeof t;if("function"!=r){if("object"!=r)return function(e){return e[t]};var i=he(t);return function(e){for(var n=i.length,r=!1;n--&&(r=f(e[i[n]],t[i[n]],S)););return r}}return e!==k?1===n?function(n){return t.call(e,n)}:2===n?function(n,r){return t.call(e,n,r)}:4===n?function(n,r,i,o){return t.call(e,n,r,i,o)}:function(n,r,i){return t.call(e,n,r,i)}:t}function x(t,e,n){function r(){c=new Date,a=null,l&&(o=t.apply(s,i))}var i,o,s,a,c=0,u=!0,l=!0;return n===!1?u=!1:n&&z[typeof n]&&(u="leading"in n?n.leading:u,l="trailing"in n?n.trailing:l),function(){var n=new Date;a||u||(c=n);var l=e-(n-c);return i=arguments,s=this,0>=l?($(a),a=null,c=n,o=t.apply(s,i)):a||(a=U(r,l)),o}}function w(t){return t}function A(t,e){return null==t&&null==e&&(e=1),t=+t||0,null==e&&(e=t,t=0),t+J(te()*((+e||0)-t+1))}function P(t){var e=++I;return(null==t?"":t)+""+e}var k,j="object"==typeof global&&global;(j.global===j||j.window===j)&&(e=j);var I=0,S={};+new Date+"";var M=/\w*$/,C=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],O="[object Arguments]",F="[object Array]",B="[object Boolean]",q="[object Date]",E="[object Function]",T="[object Number]",H="[object Object]",L="[object RegExp]",W="[object String]",R={};R[E]=!1,R[O]=R[F]=R[B]=R[q]=R[T]=R[H]=R[L]=R[W]=!0;var z={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},V=[],N={};e._;var D=RegExp("^"+(N.valueOf+"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),$=(Math.ceil,e.clearTimeout),J=(V.concat,Math.floor),Y=D.test(Y=Object.getPrototypeOf)&&Y,K=N.hasOwnProperty,U=(V.push,e.setTimeout),G=N.toString,Q=D.test(Q=G.bind)&&Q,X=D.test(X=Array.isArray)&&X,Z=(e.isFinite,e.isNaN,D.test(Z=Object.keys)&&Z),te=(Math.max,Math.min,Math.random),ee=V.slice,ne=D.test(e.attachEvent),re=Q&&!/\n|true/.test(Q+ne),ie={};ie[F]=Array,ie[B]=Boolean,ie[q]=Date,ie[H]=Object,ie[T]=Number,ie[L]=RegExp,ie[W]=String;var oe=n.support={};(function(){var t=function(){this.x=1},e=[];t.prototype={valueOf:1,y:1};for(var n in new t)e.push(n);for(n in arguments);oe.argsObject=arguments.constructor==Object&&!(arguments instanceof Array),oe.argsClass=u(arguments),oe.enumPrototypes=t.propertyIsEnumerable("prototype"),oe.fastBind=Q&&!re,oe.ownLast="x"!=e[0],oe.nonEnumArgs=0!=n,oe.nonEnumShadows=!/valueOf/.test(e),oe.unindexedChars="xx"!="x"[0]+Object("x")[0];try{oe.nodeClass=!(G.call(document)==H&&!({toString:0}+""))}catch(r){oe.nodeClass=!0}})(1);var se=function(t){var e="var index, iterable = "+t.firstArg+", result = "+t.init+";\nif (!iterable) return result;\n"+t.top+";\n";if(t.arrays?(e+="var length = iterable.length; index = -1;\nif ("+t.arrays+") {  ",oe.unindexedChars&&(e+="\n  if (isString(iterable)) {\n    iterable = iterable.split('')\n  }  "),e+="\n  while (++index < length) {\n    "+t.loop+"\n  }\n}\nelse {  "):oe.nonEnumArgs&&(e+="\n  var length = iterable.length; index = -1;\n  if (length && isArguments(iterable)) {\n    while (++index < length) {\n      index += '';\n      "+t.loop+"\n    }\n  } else {  "),oe.enumPrototypes&&(e+="\n  var skipProto = typeof iterable == 'function';\n  "),t.useHas&&t.useKeys)e+="\n  var ownIndex = -1,\n      ownProps = objectTypes[typeof iterable] ? keys(iterable) : [],\n      length = ownProps.length;\n\n  while (++ownIndex < length) {\n    index = ownProps[ownIndex];\n    ",oe.enumPrototypes&&(e+="if (!(skipProto && index == 'prototype')) {\n  "),e+=t.loop,oe.enumPrototypes&&(e+="}\n"),e+="  }  ";else if(e+="\n  for (index in iterable) {",(oe.enumPrototypes||t.useHas)&&(e+="\n    if (",oe.enumPrototypes&&(e+="!(skipProto && index == 'prototype')"),oe.enumPrototypes&&t.useHas&&(e+=" && "),t.useHas&&(e+="hasOwnProperty.call(iterable, index)"),e+=") {    "),e+=t.loop+";    ",(oe.enumPrototypes||t.useHas)&&(e+="\n    }"),e+="\n  }    ",oe.nonEnumShadows){e+="\n\n  var ctor = iterable.constructor;\n      ";for(var n=0;7>n;n++)e+="\n  index = '"+t.shadowedProps[n]+"';\n  if (","constructor"==t.shadowedProps[n]&&(e+="!(ctor && ctor.prototype === iterable) && "),e+="hasOwnProperty.call(iterable, index)) {\n    "+t.loop+"\n  }      "}return(t.arrays||oe.nonEnumArgs)&&(e+="\n}"),e+=t.bottom+";\nreturn result"},ae={args:"object, source, guard",top:"var args = arguments,\n    argsIndex = 0,\n    argsLength = typeof guard == 'number' ? 2 : args.length;\nwhile (++argsIndex < argsLength) {\n  iterable = args[argsIndex];\n  if (iterable && objectTypes[typeof iterable]) {",loop:"if (typeof result[index] == 'undefined') result[index] = iterable[index]",bottom:"  }\n}"},ce={args:"collection, callback, thisArg",top:"callback = callback && typeof thisArg == 'undefined' ? callback : lodash.createCallback(callback, thisArg)",arrays:"typeof length == 'number'",loop:"if (callback(iterable[index], index, collection) === false) return result"},ue={top:"if (!objectTypes[typeof iterable]) return result;\n"+ce.top,arrays:!1};oe.argsClass||(u=function(t){return t?K.call(t,"callee"):!1});var le=i({args:"object",init:"[]",top:"if (!(objectTypes[typeof object])) return result",loop:"result.push(index)",arrays:!1}),he=Z?function(t){return d(t)?oe.enumPrototypes&&"function"==typeof t||oe.nonEnumArgs&&t.length&&u(t)?le(t):Z(t):[]}:le,fe=i(ce),pe=i(ae,{top:ae.top.replace(";",";\nif (argsLength > 3 && typeof args[argsLength - 2] == 'function') {\n  var callback = lodash.createCallback(args[--argsLength - 1], args[argsLength--], 2);\n} else if (argsLength > 2 && typeof args[argsLength - 1] == 'function') {\n  callback = args[--argsLength];\n}"),loop:"result[index] = callback ? callback(result[index], iterable[index]) : iterable[index]"}),de=i(ce,ue,{useHas:!1}),ve=i(ce,ue);p(/x/)&&(p=function(t){return t instanceof Function||G.call(t)==E});var ge=Y?function(t){if(!t||G.call(t)!=H||!oe.argsClass&&u(t))return!1;var e=t.valueOf,n="function"==typeof e&&(n=Y(e))&&Y(n);return n?t==n||Y(t)==n:a(t)}:a;n.assign=pe,n.bind=m,n.createCallback=_,n.forEach=g,n.forIn=de,n.forOwn=ve,n.keys=he,n.shuffle=b,n.throttle=x,n.each=g,n.extend=pe,n.clone=l,n.identity=w,n.isArguments=u,n.isArray=h,n.isEqual=f,n.isFunction=p,n.isObject=d,n.isPlainObject=ge,n.isString=v,n.random=A,n.sortedIndex=y,n.uniqueId=P,n.VERSION="1.2.0",n.extend(t.util,n)}(this);var e=t.util.decorator=function e(e,n){var r={},i={},o=function o(e,n){return t.util.isFunction(n)?n:e},s=Object.getPrototypeOf;"function"!=typeof s&&(s="object"==typeof"test".__proto__?function(t){return t.__proto__}:function(t){return t.constructor.prototype});var a=Object.create;"function"!=typeof a&&(a=function(t){function e(){}return e.prototype=t,new e});var c=function c(n,r){return"object"==typeof n?(i=t.util.extend(i,n,o),i.type=e,void 0):("type"!==n&&t.util.isFunction(r)&&(i[n]=r),void 0)};c(n);var u=function u(n,c,u,l){var h,f=i;if("string"!=typeof c)l=u,u=c;else{if(f=r[c],!f)throw'Error: "'+c+'" '+e+" not defined";f=f.prototype}if("function"==typeof u)h=r[n],h?h.prototype=t.util.extend(h.prototype,u(s(h.prototype)),o):(h=r[n]=function(t){this.init&&this.init(t)},h.prototype=a(f),h.prototype=t.util.extend(h.prototype,u(f),o)),h.prototype.type=e,h.prototype.name=n;else if(l=u||{},h=r[n],!h)throw'Error: "'+n+'" '+e+" not defined";return l?new h(l):void 0};return u.mixin=c,u};return function(e){var n=e.Physics;t.noConflict=function(){return e.Physics===t&&(e.Physics=n),t}}(this),function(){var e=function e(t){return this instanceof e?(this._topics={},this.defaultScope=t||this,void 0):new e(t)};e.prototype={subscribe:function(e,n,r,i){var o,s=this._topics[e]||(this._topics[e]=[]),a=n;if(t.util.isObject(e)){for(var c in e)this.subscribe(c,e[c],n,r);return this}return t.util.isObject(r)?(n=t.util.bind(n,r),n._bindfn_=a):i=r,n._priority_=i,o=t.util.sortedIndex(s,n,"_priority_"),s.splice(o,0,n),this},unsubscribe:function(t,e){var n,r=this._topics[t];if(!r)return this;for(var i=0,o=r.length;o>i;i++)if(n=r[i],n._bindfn_===e||n===e){r.splice(i,1);break}return this},publish:function(t){"object"!=typeof t&&(t={topic:t});var e=t.topic,n=this._topics[e],r=n&&n.length;if(!e)throw"Error: No topic specified in call to world.publish()";if(!r)return this;for(t.scope=t.scope||this.defaultScope;r--;)t.handler=n[r],t.handler(t);return this}},t.util.pubsub=e}(),function(t){for(var e=0,n=["ms","moz","webkit","o"],r=0;n.length>r&&!t.requestAnimationFrame;++r)t.requestAnimationFrame=t[n[r]+"RequestAnimationFrame"],t.cancelAnimationFrame=t[n[r]+"CancelAnimationFrame"]||t[n[r]+"CancelRequestAnimationFrame"];t.requestAnimationFrame||(t.requestAnimationFrame=function(n){var r=(new Date).getTime(),i=Math.max(0,16-(r-e)),o=t.setTimeout(function(){n(r+i)},i);return e=r+i,o}),t.cancelAnimationFrame||(t.cancelAnimationFrame=function(t){clearTimeout(t)})}(this),function(){var e=100,n=10,r="Error: Scratchpad used after .done() called. (Could it be unintentionally scoped?)",i="Error: Scratchpad usage space out of bounds. (Did you forget to call .done()?)",o="Error: Too many scratchpads created. (Did you forget to call .done()?)",s=[],a=0,c=function c(){if(this.objIndex=0,this.arrayIndex=0,this.vectorIndex=0,this.aabbIndex=0,this.transformIndex=0,this.objectStack=[],this.arrayStack=[],this.vectorStack=[],this.aabbStack=[],this.transformStack=[],++a>=e)throw o};c.prototype={done:function(){this._active=!1,this.objIndex=this.arrayIndex=this.vectorIndex=this.aabbIndex=this.transformIndex=0,s.push(this)},object:function(){var t=this.objectStack;if(!this._active)throw r;if(this.objIndex>=n)throw i;return t[this.objIndex++]||t[t.push({})-1]},array:function(){var t=this.arrayStack;if(!this._active)throw r;if(this.arrIndex>=n)throw i;return t[this.arrIndex++]||t[t.push([])-1]},vector:function(){var e=this.vectorStack;if(!this._active)throw r;if(this.vectorIndex>=n)throw i;return e[this.vectorIndex++]||e[e.push(t.vector())-1]},aabb:function(){var e=this.aabbStack;if(!this._active)throw r;if(this.aabbIndex>=n)throw i;return e[this.aabbIndex++]||e[e.push(t.aabb())-1]},transform:function(){var e=this.transformStack;if(!this._active)throw r;if(this.transformIndex>=n)throw i;return e[this.transformIndex++]||e[e.push(t.transform())-1]}},t.scratchpad=function(){var t=s.pop()||new c;return t._active=!0,t}}(),function(e){function n(t){var r=l;if(u){e.requestAnimationFrame(n);for(var i=0,o=r.length;o>i;++i)r[i](t,t-c);c=t}}function r(){return c=(new Date).getTime(),u=!0,n(),this}function i(){return u=!1,this}function o(t){if("function"==typeof t){for(var e=0,n=l.length;n>e;++e)if(t===l[e])return this;l.push(t)}return this}function s(t){for(var e=l,n=0,r=e.length;r>n;++n)if(e[n]===t)return e.splice(n,1),this;return this}function a(){return!!u}var c=0,u=!1,l=[];t.util.ticker={start:r,stop:i,subscribe:o,unsubscribe:s,isActive:a}}(this),function(){var e=function e(n,r,i,o){return this instanceof e?(this._pos=t.vector(),this.set(n,r,i,o),void 0):new e(n,r,i,o)};e.prototype.set=function(e,n,r,i){return t.util.isObject(e)?(this._pos.clone(e.pos),this._hw=e.halfWidth,this._hh=e.halfHeight,this):(this._pos.set(.5*(r+e),.5*(i+n)),this._hw=.5*(r-e),this._hh=.5*(i-n),this)},e.prototype.get=function(){var t=this.halfWidth(),e=this.halfHeight();return{pos:this._pos.values(),halfWidth:t,halfHeight:e,x:t,y:e}},e.prototype.halfWidth=function(){return this._hw},e.prototype.halfHeight=function(){return this._hh},e.prototype.contains=function(t){var e=void 0!==t.x?t.x:t.get(0),n=void 0!==t.y?t.y:t.get(1);return e>this._pos.get(0)-this._hw&&this._pos.get(0)+this._hw>e&&n>this._pos.get(1)-this._hh&&this._pos.get(1)+this._hh>n},e.prototype.transform=function(e){var n=this._hw,r=this._hh,i=t.scratchpad(),o=i.vector().set(n,r),s=i.vector().set(n,-r);return this._pos.translate(e),o.rotate(e),s.rotate(e),this._hw=Math.max(Math.abs(o.get(0)),Math.abs(s.get(0))),this._hh=Math.max(Math.abs(o.get(1)),Math.abs(s.get(1))),i.done(),this},e.contains=function(t,e){var n=void 0!==e.x?e.x:e.get(0),r=void 0!==e.y?e.y:e.get(1);return t=t.get?t.get():t,n>t.pos.x-t.halfWidth&&t.pos.x+t.halfWidth>n&&r>t.pos.y-t.halfHeight&&t.pos.y+t.halfHeight>r},t.aabb=e}(),function(){var e=1e-4,n=100,r=function r(t,e,n){var r=e.normSq()-e.dot(t),i=e.dot(t)-t.normSq();return 0>r?n.clone(e).negate():i>0?n.clone(t).negate():(n.clone(e).vsub(t),n.perp(0>t.cross(n)))},i=function i(e){var n,r,i=e.length,o=e[i-2],s=e[i-3],a=t.scratchpad(),c=a.vector().clone(o.pt),u=a.vector().clone(s.pt).vsub(c);if(u.equals(t.vector.zero))return a.done(),{a:o.a,b:o.b};if(n=-u.dot(c)/u.normSq(),r=1-n,0>=r)return a.done(),{a:s.a,b:s.b};if(0>=n)return a.done(),{a:o.a,b:o.b};var l={a:c.clone(o.a).mult(r).vadd(u.clone(s.a).mult(n)).values(),b:c.clone(o.b).mult(r).vadd(u.clone(s.b).mult(n)).values()};return a.done(),l},o=function o(o,s,a,c){var u,l,h,f,p=!1,d=!1,v=!1,g=[],b=1,y=t.scratchpad(),m=y.vector().clone(s||t.vector.axis[0]),_=y.vector(),x=y.vector(),w=y.vector(),A=y.vector(),P=0;for(f=o(m),b=g.push(f),_.clone(f.pt),m.negate();++P;){if(_.swap(x),f=o(m),b=g.push(f),_.clone(f.pt),c&&c(g),_.equals(t.vector.zero)){p=!0;break}if(!d&&0>=_.dot(m)){if(a)break;d=!0}if(2===b)m=r(_,x,m);else if(d){if(m.normalize(),f=x.dot(m),e>Math.abs(f-_.dot(m))){v=-f;break}x.normSq()<w.clone(g[0].pt).normSq()?g.shift():g.splice(1,1),m=r(w.clone(g[1].pt),A.clone(g[0].pt),m)}else if(u=u||y.vector(),l=l||y.vector(),u.clone(x).vsub(_),l.clone(g[0].pt).vsub(_),h=u.cross(l)>0,h^_.cross(u)>0)g.shift(),u.perp(h),m.swap(u);else{if(!(h^l.cross(_)>0)){p=!0;break}g.splice(1,1),l.perp(!h),m.swap(u)}if(P>n)return y.done(),{simplex:g,iterations:P,distance:0,maxIterationsReached:!0}}return y.done(),f={overlap:p,simplex:g,iterations:P},v!==!1&&(f.distance=v,f.closest=i(g)),f};t.gjk=o}(),function(){var e=function e(n,r){return this instanceof e?(this.v=t.vector(),this.angle=0,n instanceof e&&this.clone(n),n&&this.setTranslation(n),this.setRotation(r||0),void 0):new e(n,r)};e.prototype.setTranslation=function(t){return this.v.clone(t),this},e.prototype.setRotation=function(t){return this.angle=0,this.cosA=Math.cos(t),this.sinA=Math.sin(t),this},e.prototype.clone=function(t){return t?(this.setTranslation(t.v),this.setRotation(t.angle),this):new e(this)},t.transform=e}(),function(e){var n=Math.sqrt,r=Math.min,i=Math.max,o=(Math.acos,Math.atan2),s=2*Math.PI,a=!!e.Float64Array,c=function c(t,e){return this instanceof c?(this._=a?new Float64Array(5):[],t&&(void 0!==t.x||t._&&t._.length)?this.clone(t):(this.recalc=!0,this.set(t||0,e||0)),void 0):new c(t,e)};c.prototype.set=function(t,e){return this.recalc=!0,this._[0]=t||0,this._[1]=e||0,this},c.prototype.get=function(t){return this._[t]},c.prototype.vadd=function(t){return this.recalc=!0,this._[0]+=t._[0],this._[1]+=t._[1],this},c.prototype.vsub=function(t){return this.recalc=!0,this._[0]-=t._[0],this._[1]-=t._[1],this},c.prototype.add=function(t,e){return this.recalc=!0,this._[0]+=t,this._[1]+=void 0===e?t:e,this},c.prototype.sub=function(t,e){return this.recalc=!0,this._[0]-=t,this._[1]-=void 0===e?t:e,this},c.prototype.mult=function(t){return this.recalc||(this._[4]*=t*t,this._[3]*=t),this._[0]*=t,this._[1]*=t,this},c.prototype.dot=function(t){return this._[0]*t._[0]+this._[1]*t._[1]},c.prototype.cross=function(t){return-this._[0]*t._[1]+this._[1]*t._[0]},c.prototype.proj=function(t){return this.dot(t)/t.norm()},c.prototype.vproj=function(t){var e=this.dot(t)/t.normSq();return this.clone(t).mult(e)},c.prototype.angle=function(t){var e=o(this._[1],this._[0]);for(t&&(e-=o(t._[1],t._[0]));e>Math.PI;)e-=s;for(;-Math.PI>e;)e+=s;return e},c.prototype.norm=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=n(this._[4])),this._[3]},c.prototype.normSq=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=n(this._[4])),this._[4]},c.prototype.dist=function(t){var e,r;return n((e=t._[0]-this._[0])*e+(r=t._[1]-this._[1])*r)},c.prototype.distSq=function(t){var e,n;return(e=t._[0]-this._[0])*e+(n=t._[1]-this._[1])*n},c.prototype.perp=function(t){var e=this._[0];return t?(this._[0]=-this._[1],this._[1]=e):(this._[0]=this._[1],this._[1]=-e),this},c.prototype.normalize=function(){var t=this.norm();return 0===t?this:(this._[0]/=t,this._[1]/=t,this._[3]=1,this._[4]=1,this)},c.prototype.transform=function(t){return this.set(this._[0]*t.cosA-this._[1]*t.sinA+t.v._[0],this._[0]*t.sinA+this._[1]*t.cosA+t.v._[1])},c.prototype.transformInv=function(t){return this.set(this._[0]*t.cosA+this._[1]*t.sinA-t.v._[0],-this._[0]*t.sinA+this._[1]*t.cosA-t.v._[1])},c.prototype.rotate=function(t){return this.set(this._[0]*t.cosA-this._[1]*t.sinA,this._[0]*t.sinA+this._[1]*t.cosA)},c.prototype.rotateInv=function(t){return this.set(this._[0]*t.cosA+this._[1]*t.sinA,-this._[0]*t.sinA+this._[1]*t.cosA)},c.prototype.translate=function(t){return this.vadd(t.v)},c.prototype.translateInv=function(t){return this.vsub(t.v)},c.prototype.clone=function(t){return t?t._?(this.recalc=t.recalc,t.recalc||(this._[3]=t._[3],this._[4]=t._[4]),this._[0]=t._[0],this._[1]=t._[1],this):this.set(t.x,t.y):new c(this)},c.prototype.swap=function(t){var e=this._;return this._=t._,t._=e,e=this.recalc,this.recalc=t.recalc,t.recalc=e,this},c.prototype.values=function(){return{x:this._[0],y:this._[1]}},c.prototype.zero=function(){return this._[3]=0,this._[4]=0,this._[0]=0,this._[1]=0,this},c.prototype.negate=function(t){return void 0!==t?(this._[t]=-this._[t],this):(this._[0]=-this._[0],this._[1]=-this._[1],this)},c.prototype.clamp=function(t,e){return t=t.values?t.values():t,e=e.values?e.values():e,this._[0]=r(i(this._[0],t.x),e.x),this._[1]=r(i(this._[1],t.y),e.y),this.recalc=!0,this},c.prototype.toString=function(){return"("+this._[0]+", "+this._[1]+")"},c.prototype.equals=function(t){return this._[0]===t._[0]&&this._[1]===t._[1]&&this._[2]===t._[2]},c.vadd=function(t,e){return new c(t._[0]+e._[0],t._[1]+e._[1])},c.vsub=function(t,e){return new c(t._[0]-e._[0],t._[1]-e._[1])},c.mult=function(t,e){return new c(e._[0]*t,e._[1]*t)},c.vproj=function(t,e){return c.mult(t.dot(e)/e.normSq(),e)},c.axis=[new c(1,0),new c(0,1)],c.zero=new c(0,0),t.vector=c}(this),function(){t.behavior=t.behaviour=e("behavior",{priority:0,init:function(){this.options={}},connect:function(t){this.behave&&t.subscribe("integrate:positions",this.behave,this,this.priority)},disconnect:function(t){this.behave&&t.unsubscribe("integrate:positions",this.behave)},behave:null})}(),function(){var n={fixed:!1,mass:1,restitution:1,cof:.8,view:null};t.body=e("body",{init:function(e){var r=t.vector;if(this.options=t.util.extend({},n,e),this.fixed=this.options.fixed,this.hidden=this.options.hidden,this.mass=this.options.mass,this.restitution=this.options.restitution,this.cof=this.options.cof,this.view=this.options.view,this.state={pos:r(e.x,e.y),vel:r(e.vx,e.vy),acc:r(),angular:{pos:e.angle||0,vel:e.angularVelocity||0,acc:0},old:{pos:r(),vel:r(),acc:r(),angular:{pos:0,vel:0,acc:0}}},0===this.mass)throw"Error: Bodies must have non-zero mass";this.geometry=t.geometry("point")},accelerate:function(t){return this.state.acc.vadd(t),this},applyForce:function(e,n){var r,i=t.scratchpad(),o=i.vector();return n?this.moi&&(r=this.state,o.clone(n),this.state.angular.acc-=o.cross(e)/this.moi,this.applyForce(e)):this.accelerate(o.clone(e).mult(1/this.mass)),i.done(),this},aabb:function(){var e=t.scratchpad(),n=e.transform(),r=this.state.angular.pos,i=e.aabb().set(this.geometry.aabb(r));return n.setRotation(0).setTranslation(this.state.pos),i.transform(n),i=i.get(),e.done(),i},recalc:function(){}})}(),function(){t.geometry=e("geometry",{init:function(){this._aabb=new t.aabb},aabb:function(){return this._aabb.get()},getFarthestHullPoint:function(e,n){return n=n||t.vector(),n.set(0,0)},getFarthestCorePoint:function(e,n){return n=n||t.vector(),n.set(0,0)}})}(),t.geometry.isPolygonConvex=function(e){var n=t.scratchpad(),r=n.vector(),i=n.vector(),o=n.vector(),s=!0,a=!1,c=e.length;if(3>c)return n.done(),s;r.clone(e[0]).vsub(o.clone(e[c-1]));for(var u=1;c>=u;++u){if(i.clone(e[u%c]).vsub(o.clone(e[(u-1)%c])),a===!1)a=r.cross(i);else if(a>0^r.cross(i)>0){s=!1;break}i.swap(r)}return n.done(),s},t.geometry.getPolygonMOI=function(e){var n,r=t.scratchpad(),i=r.vector(),o=r.vector(),s=0,a=0,c=e.length;if(2>c)return r.done(),0;if(2===c)return n=o.clone(e[1]).distSq(i.clone(e[0])),r.done(),n/12;i.clone(e[0]);for(var u=1;c>u;++u)o.clone(e[u]),n=Math.abs(o.cross(i)),s+=n*(o.normSq()+o.dot(i)+i.normSq()),a+=n,i.swap(o);return r.done(),s/(6*a)},t.geometry.isPointInPolygon=function(e,n){var r=t.scratchpad(),i=r.vector().clone(e),o=r.vector(),s=r.vector(),a=0,c=n.length;if(2>c)return a=i.equals(o.clone(n[0])),r.done(),a;if(2===c)return a=i.angle(o.clone(n[0])),a+=i.angle(o.clone(n[1])),r.done(),Math.abs(a)===Math.PI;o.clone(n[0]).vsub(i);for(var u=1;c>=u;++u)s.clone(n[u%c]).vsub(i),a+=s.angle(o),o.swap(s);return r.done(),Math.abs(a)>0},t.geometry.getPolygonArea=function(e){var n=t.scratchpad(),r=n.vector(),i=n.vector(),o=0,s=e.length;if(3>s)return n.done(),0;r.clone(e[s-1]);for(var a=0;s>a;++a)i.clone(e[a]),o+=r.cross(i),r.swap(i);return n.done(),o/2},t.geometry.getPolygonCentroid=function(e){var n,r=t.scratchpad(),i=r.vector(),o=r.vector(),s=t.vector(),a=e.length;if(2>a)return r.done(),t.vector(e[0]);if(2===a)return r.done(),t.vector((e[1].x+e[0].x)/2,(e[1].y+e[0].y)/2);i.clone(e[a-1]);for(var c=0;a>c;++c)o.clone(e[c]),n=i.cross(o),i.vadd(o).mult(n),s.vadd(i),i.swap(o);return n=1/(6*t.geometry.getPolygonArea(e)),r.done(),s.mult(n)},t.geometry.nearestPointOnLine=function(e,n,r){var i,o,s=t.scratchpad(),a=s.vector().clone(e),c=s.vector().clone(n).vsub(a),u=s.vector().clone(r).vsub(a).vsub(c);return u.equals(t.vector.zero)?(s.done(),t.vector(n)):(i=-u.dot(c)/u.normSq(),o=1-i,0>=o?(s.done(),t.vector(r)):0>=i?(s.done(),t.vector(n)):(a=t.vector(r).mult(i).vadd(c.clone(n).mult(o)),s.done(),a))},function(){var n={drag:0};t.integrator=e("integrator",{init:function(e){this.options=t.util.extend({},n,e)},integrate:function(t,e){var n=this._world;return this.integrateVelocities(t,e),n&&n.publish({topic:"integrate:velocities",bodies:t,dt:e}),this.integratePositions(t,e),n&&n.publish({topic:"integrate:positions",bodies:t,dt:e}),this},integrateVelocities:function(){throw"The integrator.integrateVelocities() method must be overriden"},integratePositions:function(){throw"The integrator.integratePositions() method must be overriden"}})}(),function(){var n={meta:!0,metaRefresh:200,width:600,height:600};t.renderer=e("renderer",{init:function(e){var r="string"==typeof e.el?document.getElementById(e.el):e.el;this.options=t.util.extend({},n,e),this.el=r?r:document.body,this.drawMeta=t.util.throttle(t.util.bind(this.drawMeta,this),this.options.metaRefresh)},render:function(t,e){var n,r;this.beforeRender&&this.beforeRender(),this.options.meta&&this.drawMeta(e);for(var i=0,o=t.length;o>i;++i)n=t[i],r=n.view||(n.view=this.createView(n.geometry)),n.hidden||this.drawBody(n,r);return this},createView:function(){throw"You must overried the renderer.createView() method."},drawMeta:function(){throw"You must overried the renderer.drawMeta() method."},drawBody:function(){throw"You must overried the renderer.drawBody() method."}})}(),function(){var e=function(t){this.disconnect&&this._world&&this.disconnect(this._world),this._world=t,this.connect&&t&&this.connect(t)};t.util.each("body,behavior,integrator,renderer".split(","),function(n){t[n].mixin("setWorld",e)});var n={timestep:6.25,maxIPF:16,webworker:!1,integrator:"verlet"},r=function r(t,e){return this instanceof r?(this.init(t,e),void 0):new r(t,e)};r.prototype={init:function(e,n){t.util.isFunction(e)&&(n=e,e={}),this._stats={fps:0,ipf:0},this._bodies=[],this._behaviors=[],this._integrator=null,this._renderer=null,this._paused=!1,this._opts={},this._pubsub=t.util.pubsub(this),this.options(e||{}),t.util.isFunction(n)&&n.call(this,this)},options:function(e){return e?(t.util.extend(this._opts,n,e),this.timeStep(this._opts.timestep),this.add(t.integrator(this._opts.integrator)),this):t.util.clone(this._opts)},subscribe:function(t,e,n,r){return this._pubsub.subscribe(t,e,n,r),this},unsubscribe:function(t,e){return this._pubsub.unsubscribe(t,e),this},publish:function(t,e){return this._pubsub.publish(t,e),this},add:function(t){var e,n=0,r=t&&t.length||0,i=r?t[0]:t;if(!i)return this;do{switch(i.type){case"behavior":this.addBehavior(i);break;case"integrator":this.integrator(i);break;case"renderer":this.renderer(i);break;case"body":this.addBody(i);break;default:throw"Error: failed to add item of type "+i.type+" to world"}e={topic:"add:"+i.type},e[i.type]=i,this.publish(e)}while(r>++n&&(i=t[n]));return this},integrator:function(t){return t?(this._integrator&&this._integrator.setWorld(null),this._integrator=t,this._integrator.setWorld(this),this):this._integrator},renderer:function(t){return t?(this._renderer&&this._renderer.setWorld(null),this._renderer=t,this._renderer.setWorld(this),this):this._renderer},timeStep:function(t){return t?(this._dt=t,this._maxJump=t*this._opts.maxIPF,this):this._dt},addBehavior:function(t){return t.setWorld(this),this._behaviors.push(t),this},removeBehavior:function(t){var e=this._behaviors;if(t)for(var n=0,r=e.length;r>n;++n)if(t===e[n]){e.splice(n,1);break}return this},addBody:function(t){return t.setWorld(this),this._bodies.push(t),this},getBodies:function(){return[].concat(this._bodies)},removeBody:function(t){var e=this._bodies;if(t)for(var n=0,r=e.length;r>n;++n)if(t===e[n]){e.splice(n,1);break}return this},findOne:function(e){var n={check:function(t){for(var e=this;e=e.next;)if(e(t))return!0;return!1}},r=n,i=this._bodies;e.$within,e.$at&&(r.next=function(n){var r=n.aabb();return t.aabb.contains(r,e.$at)});for(var o=0,s=i.length;s>o;++o)if(n.check(i[o]))return i[o];return!1},iterate:function(t){this._integrator.integrate(this._bodies,t)},step:function(t){if(this._paused)return this._time=!1,this;var e=this._time||(this._time=t),n=t-e,r=this._stats,i=this._dt;if(!n)return this;for(n>this._maxJump&&(this._time=t-this._maxJump,n=this._maxJump),r.fps=1e3/n,r.ipf=Math.ceil(n/this._dt);t>this._time;)this._time+=i,this.iterate(i);return this.publish({topic:"step"}),this},render:function(){if(!this._renderer)throw"No renderer added to world";return this._renderer.render(this._bodies,this._stats),this.publish({topic:"render",bodies:this._bodies,renderer:this._renderer}),this},pause:function(){return this._paused=!0,this.publish({topic:"pause"}),this},unpause:function(){return this._paused=!1,this.publish({topic:"unpause"}),this},isPaused:function(){return!!this._paused}},t.world=r}(),t.integrator("verlet",function(e){return t.body.mixin({started:function(t){return void 0!==t&&(this._started=!0),!!this._started}}),{init:function(t){e.init.call(this,t)},integrateVelocities:function(t,e){for(var n,r=e*e,i=1-this.options.drag,o=null,s=0,a=t.length;a>s;++s)o=t[s],n=o.state,o.fixed?(n.vel.zero(),n.acc.zero(),n.angular.vel=0,n.angular.acc=0):(n.vel.equals(n.old.vel)&&o.started()?n.vel.clone(n.pos).vsub(n.old.pos):(n.old.pos.clone(n.pos).vsub(n.vel),n.vel.mult(e)),i&&n.vel.mult(i),n.vel.vadd(n.acc.mult(r)),n.vel.mult(1/e),n.old.vel.clone(n.vel),n.acc.zero(),n.angular.vel===n.old.angular.vel&&o.started()?n.angular.vel=n.angular.pos-n.old.angular.pos:(n.old.angular.pos=n.angular.pos-n.angular.vel,n.angular.vel*=e),n.angular.vel+=n.angular.acc*r,n.angular.vel/=e,n.old.angular.vel=n.angular.vel,n.angular.acc=0,o.started(!0))},integratePositions:function(t,e){for(var n,r=null,i=0,o=t.length;o>i;++i)r=t[i],n=r.state,r.fixed||(n.vel.mult(e),n.old.pos.clone(n.pos),n.pos.vadd(n.vel),n.vel.mult(1/e),n.old.vel.clone(n.vel),n.angular.vel*=e,n.old.angular.pos=n.angular.pos,n.angular.pos+=n.angular.vel,n.angular.vel/=e,n.old.angular.vel=n.angular.vel)}}}),t.geometry("circle",function(e){var n={radius:1};return{init:function(r){e.init.call(this,r),r=t.util.extend({},n,r),this.radius=r.radius,this._aabb=t.aabb()},aabb:function(){var t=this.radius,e=this._aabb;
return e.halfWidth()===t?e.get():e.set(-t,-t,t,t).get()},getFarthestHullPoint:function(e,n){return n=n||t.vector(),n.clone(e).normalize().mult(this.radius)},getFarthestCorePoint:function(e,n,r){return n=n||t.vector(),n.clone(e).normalize().mult(this.radius-r)}}}),t.geometry("convex-polygon",function(e){var n="Error: The vertices specified do not match that of a _convex_ polygon.",r={};return{init:function(n){e.init.call(this,n),n=t.util.extend({},r,n),this.setVertices(n.vertices||[t.vector()])},setVertices:function(e){var r=t.scratchpad(),i=r.transform(),o=this.vertices=[];if(!t.geometry.isPolygonConvex(e))throw n;i.setRotation(0),i.setTranslation(t.geometry.getPolygonCentroid(e).negate());for(var s=0,a=e.length;a>s;++s)o.push(t.vector(e[s]).translate(i));return this._area=t.geometry.getPolygonArea(o),this._aabb=!1,r.done(),this},aabb:function(e){if(!e&&this._aabb)return this._aabb.get();var n,r=t.scratchpad(),i=r.vector(),o=r.transform().setRotation(e||0),s=r.vector().clone(t.vector.axis[0]).rotateInv(o),a=r.vector().clone(t.vector.axis[1]).rotateInv(o),c=this.getFarthestHullPoint(s,i).proj(s),u=-this.getFarthestHullPoint(s.negate(),i).proj(s),l=this.getFarthestHullPoint(a,i).proj(a),h=-this.getFarthestHullPoint(a.negate(),i).proj(a);return n=new t.aabb(u,h,c,l),e||(this._aabb=n),r.done(),n.get()},getFarthestHullPoint:function(e,n,r){var i,o,s,a=this.vertices,c=a.length,u=2;if(n=n||t.vector(),2>c)return r&&(r.idx=0),n.clone(a[0]);if(o=a[0].dot(e),i=a[1].dot(e),2===c)return s=i>=o?1:0,r&&(r.idx=s),n.clone(a[s]);if(i>=o){for(;c>u&&i>=o;)o=i,i=a[u].dot(e),u++;return i>=o&&u++,s=u-2,r&&(r.idx=u-2),n.clone(a[s])}for(u=c;u>2&&o>=i;)u--,i=o,o=a[u].dot(e);return s=(u+1)%c,r&&(r.idx=s),n.clone(a[s])},getFarthestCorePoint:function(e,n,r){var i,o=t.scratchpad(),s=o.vector(),a=o.vector(),c=this.vertices,u=c.length,l=this._area>0,h={};return n=this.getFarthestHullPoint(e,n,h),s.clone(c[(h.idx+1)%u]).vsub(n).normalize().perp(!l),a.clone(c[(h.idx-1+u)%u]).vsub(n).normalize().perp(l),i=r/(1+s.dot(a)),n.vadd(s.vadd(a).mult(i)),o.done(),n}}}),t.geometry("point",function(){}),t.body("circle",function(e){var n={};return{init:function(r){e.init.call(this,r),r=t.util.extend({},n,r),this.geometry=t.geometry("circle",{radius:r.radius}),this.recalc()},recalc:function(){e.recalc.call(this),this.moi=this.mass*this.geometry.radius*this.geometry.radius/2}}}),t.body("convex-polygon",function(e){var n={};return{init:function(r){e.init.call(this,r),r=t.util.extend({},n,r),this.geometry=t.geometry("convex-polygon",{vertices:r.vertices}),this.recalc()},recalc:function(){e.recalc.call(this),this.moi=t.geometry.getPolygonMOI(this.geometry.vertices)}}}),t.body("point",function(){}),t.behavior("body-collision-detection",function(e){var n="collisions:candidates",r="collisions:detected",i=function i(e,n){var r;return r=function(i){var o,s=t.scratchpad(),a=s.transform().setTranslation(e.state.pos).setRotation(e.state.angular.pos),c=s.transform().setTranslation(n.state.pos).setRotation(n.state.angular.pos),u=s.vector(),l=s.vector(),h=r.useCore?"getFarthestCorePoint":"getFarthestHullPoint",f=r.marginA,p=r.marginB;return u=e.geometry[h](i.rotateInv(a),u,f).transform(a),l=n.geometry[h](i.rotate(a).rotateInv(c).negate(),l,p).transform(c),i.negate().rotate(c),o={a:u.values(),b:l.values(),pt:u.vsub(l).values()},s.done(),o},r.useCore=!1,r.margin=0,r},o=function o(e,n){var r,o,s,a=t.scratchpad(),c=a.vector(),u=a.vector(),l=!1,h=e.aabb(),f=Math.min(h.halfWidth,h.halfHeight),p=n.aabb(),d=Math.min(p.halfWidth,p.halfHeight);if(s=i(e,n),c.clone(e.state.pos).vsub(n.state.pos),o=t.gjk(s,c,!0),o.overlap){for(l={bodyA:e,bodyB:n},s.useCore=!0,s.marginA=0,s.marginB=0;o.overlap&&(f>s.marginA||d>s.marginB);)f>s.marginA&&(s.marginA+=1),d>s.marginB&&(s.marginB+=1),o=t.gjk(s,c);if(o.overlap||o.maxIterationsReached)return a.done(),!1;r=Math.max(0,s.marginA+s.marginB-o.distance),l.overlap=r,l.norm=c.clone(o.closest.b).vsub(u.clone(o.closest.a)).normalize().values(),l.mtv=c.mult(r).values(),l.pos=c.clone(l.norm).mult(s.margin).vadd(u.clone(o.closest.a)).vsub(e.state.pos).values()}return a.done(),l},s=function s(e,n){var r,i=t.scratchpad(),o=i.vector(),s=(i.vector(),!1);return o.clone(n.state.pos).vsub(e.state.pos),r=o.norm()-(e.geometry.radius+n.geometry.radius),o.equals(t.vector.zero)&&o.set(1,0),0>=r&&(s={bodyA:e,bodyB:n,norm:o.normalize().values(),mtv:o.mult(-r).values(),pos:o.normalize().mult(e.geometry.radius).values(),overlap:-r}),i.done(),s},a=function a(t,e){return"circle"===t.geometry.name&&"circle"===e.geometry.name?s(t,e):o(t,e)},c={checkAll:!1};return{priority:10,init:function(n){e.init.call(this,n),this.options=t.util.extend({},this.options,c,n)},connect:function(t){t.subscribe(n,this.check,this),t.subscribe("integrate:velocities",this.checkAll,this)},disconnect:function(t){t.unsubscribe(n,this.check),t.unsubscribe("integrate:velocities",this.checkAll)},check:function(t){for(var e,n,i=t.candidates,o=[],s=0,c=i.length;c>s;++s)e=i[s],n=a(e.bodyA,e.bodyB),n&&o.push(n);o.length&&this._world.publish({topic:r,collisions:o})},checkAll:function(t){var e=t.bodies;if(t.dt,this.options.checkAll){for(var n,i,o,s=[],c=0,u=e.length;u>c;c++){n=e[c];for(var l=c+1;u>l;l++)i=e[l],n.fixed&&i.fixed||(o=a(n,i),o&&s.push(o))}s.length&&this._world.publish({topic:r,collisions:s})}},behave:function(){}}}),t.behavior("body-impulse-response",function(e){var n="collisions:detected";return{priority:1,init:function(){},setWorld:function(t){this._world&&this._world.unsubscribe(n,this.respond),t.subscribe(n,this.respond,this),e.setWorld.call(this,t)},collideBodies:function(e,n,r,i,o,s){var a=e.fixed,c=n.fixed,u=t.scratchpad(),l=u.vector().clone(o);if(!a||!c){a?n.state.pos.vadd(l):c?e.state.pos.vsub(l):(l.mult(.5),e.state.pos.vsub(l),n.state.pos.vadd(l));var h,f,p,d=a?0:1/e.moi,v=c?0:1/n.moi,g=a?0:1/e.mass,b=c?0:1/n.mass,y=s?0:e.restitution*n.restitution,m=e.cof*n.cof,_=u.vector().clone(r),x=u.vector().clone(_).perp(!0),w=u.vector().clone(i),A=u.vector().clone(i).vadd(e.state.pos).vsub(n.state.pos),P=u.vector(),k=e.state.angular.vel,j=n.state.angular.vel,I=u.vector().clone(n.state.vel).vadd(P.clone(A).perp(!0).mult(j)).vsub(e.state.vel).vsub(P.clone(w).perp(!0).mult(k)),S=w.proj(_),M=w.proj(x),C=A.proj(_),O=A.proj(x),F=I.proj(_),B=I.proj(x),q=!1;if(F>=0)return u.done(),void 0;h=-((1+y)*F)/(g+b+d*M*M+v*O*O),a?(n.state.vel.vadd(_.mult(h*b)),n.state.angular.vel-=h*v*O):c?(e.state.vel.vsub(_.mult(h*g)),e.state.angular.vel+=h*d*M):(n.state.vel.vadd(_.mult(h*b)),n.state.angular.vel-=h*v*O,e.state.vel.vsub(_.mult(g*n.mass)),e.state.angular.vel+=h*d*M),m&&B&&(p=B/(g+b+d*S*S+v*C*C),q?h=p:(f=0>B?-1:1,h*=f*m,h=1===f?Math.min(h,p):Math.max(h,p)),a?(n.state.vel.vsub(x.mult(h*b)),n.state.angular.vel-=h*v*C):c?(e.state.vel.vadd(x.mult(h*g)),e.state.angular.vel+=h*d*S):(n.state.vel.vsub(x.mult(h*b)),n.state.angular.vel-=h*v*C,e.state.vel.vadd(x.mult(g*n.mass)),e.state.angular.vel+=h*d*S)),u.done()}},respond:function(e){for(var n,r=this,i=t.util.shuffle(e.collisions),o=0,s=i.length;s>o;++o)n=i[o],r.collideBodies(n.bodyA,n.bodyB,n.norm,n.pos,n.mtv)},behave:function(){}}}),t.behavior("constant-acceleration",function(e){var n={acc:{x:0,y:4e-4}};return{init:function(r){e.init.call(this,r),this.options=t.util.extend(this.options,n,r),this._acc=t.vector(),this.setAcceleration(this.options.acc)},setAcceleration:function(t){return this._acc.clone(t),this},behave:function(t){for(var e=t.bodies,n=0,r=e.length;r>n;++n)e[n].accelerate(this._acc)}}}),t.behavior("edge-collision-detection",function(e){var n="collisions:detected",r=function r(e,n,r){var i,o=e.aabb(),s=t.scratchpad(),a=s.transform(),c=s.vector(),u=s.vector(),l=!1,h=[];return i=o.pos.x+o.x-n.max.x,i>=0&&(c.set(1,0).rotateInv(a.setRotation(e.state.angular.pos)),l={bodyA:e,bodyB:r,overlap:i,norm:{x:1,y:0},mtv:{x:i,y:0},pos:e.geometry.getFarthestHullPoint(c,u).rotate(a).values()},h.push(l)),i=o.pos.y+o.y-n.max.y,i>=0&&(c.set(0,1).rotateInv(a.setRotation(e.state.angular.pos)),l={bodyA:e,bodyB:r,overlap:i,norm:{x:0,y:1},mtv:{x:0,y:i},pos:e.geometry.getFarthestHullPoint(c,u).rotate(a).values()},h.push(l)),i=n.min.x-(o.pos.x-o.x),i>=0&&(c.set(-1,0).rotateInv(a.setRotation(e.state.angular.pos)),l={bodyA:e,bodyB:r,overlap:i,norm:{x:-1,y:0},mtv:{x:-i,y:0},pos:e.geometry.getFarthestHullPoint(c,u).rotate(a).values()},h.push(l)),i=n.min.y-(o.pos.y-o.y),i>=0&&(c.set(0,-1).rotateInv(a.setRotation(e.state.angular.pos)),l={bodyA:e,bodyB:r,overlap:i,norm:{x:0,y:-1},mtv:{x:0,y:-i},pos:e.geometry.getFarthestHullPoint(c,u).rotate(a).values()},h.push(l)),s.done(),h},i=function i(t,e,n){return r(t,e,n)},o={aabb:null,restitution:.99,cof:1};return{priority:12,init:function(n){e.init.call(this,n),this.options=t.util.extend({},this.options,o,n),this.setAABB(n.aabb),this.restitution=n.restitution,this._dummy=t.body("_dummy",function(){},{fixed:!0,restitution:this.options.restitution,cof:this.options.cof})},setAABB:function(t){if(!t)throw"Error: aabb not set";t=t.get&&t.get()||t,this._edges={min:{x:t.pos.x-t.x,y:t.pos.y-t.y},max:{x:t.pos.x+t.x,y:t.pos.y+t.y}}},connect:function(t){t.subscribe("integrate:velocities",this.checkAll,this)},disconnect:function(t){t.unsubscribe("integrate:velocities",this.checkAll)},checkAll:function(t){for(var e,r,o=t.bodies,s=(t.dt,[]),a=this._edges,c=this._dummy,u=0,l=o.length;l>u;u++)e=o[u],e.fixed||(r=i(e,a,c),r&&s.push.apply(s,r));s.length&&this._world.publish({topic:n,collisions:s})},behave:function(){}}}),t.behavior("newtonian",function(e){var n={strength:1};return{init:function(r){e.init.call(this,r),r=t.util.extend({},n,r),this.strength=r.strength,this.tolerance=r.tolerance||100*this.strength},behave:function(e){for(var n,r,i,o,s=e.bodies,a=this.strength,c=this.tolerance,u=t.scratchpad(),l=u.vector(),h=0,f=s.length;f>h;h++){n=s[h];for(var p=h+1;f>p;p++)r=s[p],l.clone(r.state.pos),l.vsub(n.state.pos),i=l.normSq(),i>c&&(o=a/i,n.accelerate(l.normalize().mult(o*r.mass)),r.accelerate(l.mult(n.mass/r.mass).negate()))}u.done()}}}),t.behavior("rigid-constraint-manager",function(e){var n={targetLength:20};return{init:function(r){e.init.call(this,r),t.util.extend(this.options,n,r),this._constraints=[]},connect:function(t){var e=t.integrator();if(e&&0>e.name.indexOf("verlet"))throw'The rigid constraint manager needs a world with a "verlet" compatible integrator.';t.subscribe("integrate:positions",this.resolve,this)},disconnect:function(t){t.unsubscribe("integrate:positions",this.resolve)},drop:function(){return this._constraints=[],this},constrain:function(e,n,r){return e&&n?(this._constraints.push({id:t.util.uniqueId("rigid-constraint"),bodyA:e,bodyB:n,targetLength:r||this.options.targetLength}),this):this},remove:function(e){var n,r=this._constraints;if("string"!=typeof e)return r.splice(e,1),this;n=t.util.isObject(e);for(var i=0,o=r.length;o>i;++i)if(n&&r[i]===e||!n&&r[i].id===e)return r.splice(i,1),this;return this},resolve:function(){for(var e,n,r,i,o=this._constraints,s=t.scratchpad(),a=s.vector(),c=s.vector(),u=0,l=o.length;l>u;++u)e=o[u],a.clone(e.bodyA.state.pos),c.clone(e.bodyB.state.pos).vsub(a),n=c.norm(),r=(n-e.targetLength)/n,c.mult(r),i=e.bodyB.mass/(e.bodyA.mass+e.bodyB.mass),e.bodyA.fixed||(c.mult(i),e.bodyA.state.pos.vadd(c),c.mult(1/i)),e.bodyB.fixed||(c.mult(1-i),e.bodyB.state.pos.vsub(c));s.done()},getConstraints:function(){return[].concat(this._constraints)}}}),t.behavior("sweep-prune",function(e){function n(t,e){return t===e?!1:t>e?t<<16|65535&e:e<<16|65535&t}var r="collisions:candidates",i=1,o=function o(){return i++},s={x:0,y:1};return{priority:10,init:function(t){e.init.call(this,t),this.clear()},clear:function(){this.tracked=[],this.pairs=[],this.intervalLists={};for(var t in s)this.intervalLists[t]=[]},setWorld:function(t){this.clear(),this._world&&this._world.unsubscribe("add:body",this.trackBody),t.subscribe("add:body",this.trackBody,this);for(var n=t.getBodies(),r=0,i=n.length;i>r;++r)this.trackBody({body:n[r]});e.setWorld.call(this,t)},broadPhase:function(){return this.updateIntervals(),this.sortIntervalLists(),this.checkOverlaps()},sortIntervalLists:function(){var t,e,n,r,i,o,a,c,u;for(var l in s)for(t=this.intervalLists[l],n=0,e=t.length,u=s[l];e>++n;){for(i=t[n],o=i.val.get(u),r=n,a=t[r-1],c=a&&a.val.get(u);r>0&&(c>o||c===o&&a.type&&!i.type);)t[r]=a,r--,a=t[r-1],c=a&&a.val.get(u);t[r]=i}},getPair:function(t,e,r){var i=n(t.id,e.id);if(i===!1)return null;var o=this.pairs[i];if(!o){if(!r)return null;o=this.pairs[i]={bodyA:t.body,bodyB:e.body,flag:0}}return o},checkOverlaps:function(){var t,e,n,r,i,o,a,c,u,l=s.z||s.y||s.x,h=[],f=0,p=[];for(var d in s)for(t="x"===d,i=this.intervalLists[d],a=-1,o=i.length;o>++a;)if(r=i[a],e=r.tracker,r.type)for(c=f;--c>=0;)n=h[c],n===e?(f-1>c?h[c]=h.pop():h.pop(),f--):(u=this.getPair(e,n,t),u&&(u.flag=t?0:u.flag+1,u.flag===l&&p.push(u)));else f=h.push(e);return p},updateIntervals:function(){for(var e,n,r=t.scratchpad(),i=r.vector(),o=r.vector(),s=this.tracked,a=s.length;--a>=0;)e=s[a],n=e.interval,i.clone(e.body.state.pos),o.clone(e.body.aabb()),n.min.val.clone(i).vsub(o),n.max.val.clone(i).vadd(o);r.done()},trackBody:function(e){var n=e.body,r={id:o(),body:n},i={min:{type:!1,val:t.vector(),tracker:r},max:{type:!0,val:t.vector(),tracker:r}};r.interval=i,this.tracked.push(r);for(var a in s)this.intervalLists[a].push(i.min,i.max)},connect:function(t){t.subscribe("integrate:velocities",this.sweep,this)},disconnect:function(t){t.unsubscribe("integrate:velocities",this.sweep)},sweep:function(t){var e,n=this;t.bodies,t.dt,e=n.broadPhase(),e.length&&this._world.publish({topic:r,candidates:e})},behave:function(){}}}),t.integrator("improved-euler",function(e){return{init:function(t){e.init.call(this,t)},integrateVelocities:function(t,e){for(var n,r=1-this.options.drag,i=null,o=0,s=t.length;s>o;++o)i=t[o],n=i.state,i.fixed?(n.vel.zero(),n.acc.zero(),n.angular.vel=0,n.angular.acc=0):(n.old.vel.clone(n.vel),n.old.acc.clone(n.acc),n.vel.vadd(n.acc.mult(e)),r&&n.vel.mult(r),n.acc.zero(),n.old.angular.vel=n.angular.vel,n.angular.vel+=n.angular.acc*e,n.angular.acc=0)},integratePositions:function(e,n){for(var r,i=.5*n*n,o=null,s=t.scratchpad(),a=s.vector(),c=0,u=e.length;u>c;++c)o=e[c],r=o.state,o.fixed||(r.old.pos.clone(r.pos),a.clone(r.old.vel),r.pos.vadd(a.mult(n)).vadd(r.old.acc.mult(i)),r.old.acc.zero(),r.old.angular.pos=r.angular.pos,r.angular.pos+=r.old.angular.vel*n+r.old.angular.acc*i,r.old.angular.acc=0);s.done()}}}),t.renderer("canvas",function(e){var n=2*Math.PI,r=function(t,e){var n=document.createElement(t||"div");return e&&(n.innerHTML=e),n},i={debug:!1,statsEl:null,styles:{point:"rgba(80, 50, 100, 0.7)",circle:{strokeStyle:"rgba(70, 50, 100, 0.7)",lineWidth:1,fillStyle:"rgba(44, 105, 44, 0.7)",angleIndicator:"rgba(69, 51, 78, 0.7)"},"convex-polygon":{strokeStyle:"rgba(80, 50, 100, 0.7)",lineWidth:1,fillStyle:"rgba(114, 105, 124, 0.7)",angleIndicator:"rgba(69, 51, 78, 0.7)"}},offset:t.vector()},o=function(e,n){return t.util.isPlainObject(n)?t.util.extend({},e,n,o):n?n:e};return{init:function(n){if(e.init.call(this,n),this.options=t.util.extend({},i,this.options,o),this.hiddenCanvas=document.createElement("canvas"),this.hiddenCanvas.width=this.hiddenCanvas.height=100,!this.hiddenCanvas.getContext)throw"Canvas not supported";this.hiddenCtx=this.hiddenCanvas.getContext("2d");var s=this.el;"CANVAS"!==s.nodeName.toUpperCase()&&(s=document.createElement("canvas"),this.el.appendChild(s),this.el=s),s.width=this.options.width,s.height=this.options.height,this.ctx=s.getContext("2d"),this.els={};var a=this.options.statsEl||r();a.className="pjs-meta",this.els.fps=r("span"),this.els.ipf=r("span"),a.appendChild(r("span","fps: ")),a.appendChild(this.els.fps),a.appendChild(r("br")),a.appendChild(r("span","ipf: ")),a.appendChild(this.els.ipf),s.parentNode.insertBefore(a,s)},setStyle:function(e,n){n=n||this.ctx,t.util.isObject(e)?(n.strokeStyle=e.strokeStyle,n.fillStyle=e.fillStyle,n.lineWidth=e.lineWidth):(n.fillStyle=n.strokeStyle=e,n.lineWidth=1)},drawCircle:function(t,e,r,i,o){o=o||this.ctx,o.beginPath(),this.setStyle(i,o),o.arc(t,e,r,0,n,!1),o.closePath(),o.stroke(),o.fill()},drawPolygon:function(t,e,n){var r=t[0],i=void 0===r.x?r.get(0):r.x,o=void 0===r.y?r.get(1):r.y,s=t.length;n=n||this.ctx,n.beginPath(),this.setStyle(e,n),n.moveTo(i,o);for(var a=1;s>a;++a)r=t[a],i=void 0===r.x?r.get(0):r.x,o=void 0===r.y?r.get(1):r.y,n.lineTo(i,o);s>2&&n.closePath(),n.stroke(),n.fill()},drawLine:function(t,e,n,r){var i=void 0===t.x?t.get(0):t.x,o=void 0===t.y?t.get(1):t.y;r=r||this.ctx,r.beginPath(),this.setStyle(n,r),r.moveTo(i,o),i=void 0===e.x?e.get(0):e.x,o=void 0===e.y?e.get(1):e.y,r.lineTo(i,o),r.stroke(),r.fill()},createView:function(t,e){var n=new Image,r=t.aabb(),i=r.halfWidth+Math.abs(r.pos.x),o=r.halfHeight+Math.abs(r.pos.y),s=i+1,a=o+1,c=this.hiddenCtx,u=this.hiddenCanvas,l=t.name;return e=e||this.options.styles[l],s+=0|e.lineWidth,a+=0|e.lineWidth,u.width=2*i+2+(0|2*e.lineWidth),u.height=2*o+2+(0|2*e.lineWidth),c.save(),c.translate(s,a),"circle"===l?this.drawCircle(0,0,t.radius,e,c):"convex-polygon"===l&&this.drawPolygon(t.vertices,e,c),e.angleIndicator&&(c.beginPath(),this.setStyle(e.angleIndicator,c),c.moveTo(0,0),c.lineTo(i,0),c.closePath(),c.stroke()),c.restore(),n.src=u.toDataURL("image/png"),n},drawMeta:function(t){this.els.fps.innerHTML=t.fps.toFixed(2),this.els.ipf.innerHTML=t.ipf},beforeRender:function(){this.el.width=this.el.width},drawBody:function(t,e){var n=this.ctx,r=t.state.pos,i=this.options.offset,o=t.aabb();n.save(),n.translate(r.get(0)+i.get(0),r.get(1)+i.get(1)),n.rotate(t.state.angular.pos),n.drawImage(e,-e.width/2,-e.height/2),n.restore(),this.options.debug&&(n.save(),n.translate(i.get(0),i.get(1)),this.drawPolygon([{x:o.pos.x-o.x,y:o.pos.y-o.y},{x:o.pos.x+o.x,y:o.pos.y-o.y},{x:o.pos.x+o.x,y:o.pos.y+o.y},{x:o.pos.x-o.x,y:o.pos.y+o.y}],"rgba(100, 255, 100, 0.3)"),n.restore())}}}),t.renderer("dom",function(t){var e,n={},r=document.createElement("div"),i=function i(t){return t.replace(/(?:^|\s)\w/g,function(t){return t.toUpperCase()})},o=function o(t){if(n[t])return n[t];for(var e,o=["Webkit","Moz","Ms","O"],s=0,a=o.length;a>s;++s)if(e=o[s]+i(t),e in r.style)return n[t]=e;return e in r.style?n[t]=t:!1},s="pjs-",a="px",c=o("transform"),u=function(t,e){var n=document.createElement(t||"div");return e&&(n.innerHTML=e),n};return e=c?function(t,e){var n=t.state.pos;e.style[c]="translate("+n.get(0)+"px,"+n.get(1)+"px) rotate("+t.state.angular.pos+"rad)"}:function(t,e){var n=t.state.pos;e.style.left=n.get(0)+a,e.style.top=n.get(1)+a},{init:function(e){t.init.call(this,e);var n=this.el;n.style.position="relative",n.style.overflow="hidden",n.style.width=this.options.width+a,n.style.height=this.options.height+a,this.els={};var r=u();r.className="pjs-meta",this.els.fps=u("span"),this.els.ipf=u("span"),r.appendChild(u("span","fps: ")),r.appendChild(this.els.fps),r.appendChild(u("br")),r.appendChild(u("span","ipf: ")),r.appendChild(this.els.ipf),n.appendChild(r)},circleProperties:function(t,e){var n=e.aabb();t.style.width=2*n.halfWidth+a,t.style.height=2*n.halfHeight+a,t.style.marginLeft=-n.halfWidth+a,t.style.marginTop=-n.halfHeight+a},createView:function(t){var e=u(),n=t.name+"Properties";return e.className=s+t.name,e.style.position="absolute",e.style.top="0px",e.style.left="0px",this[n]&&this[n](e,t),this.el.appendChild(e),e},drawMeta:function(t){this.els.fps.innerHTML=t.fps.toFixed(2),this.els.ipf.innerHTML=t.ipf},drawBody:e}}),t});